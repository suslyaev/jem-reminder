<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Аудит группы — {{ group[2] if group else 'Группа' }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      .pagination-container { display:flex; justify-content:space-between; align-items:center; margin: 8px 0; padding-top:8px; border-top:1px solid var(--border); }
      .pagination-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--card); color: var(--text); border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 14px; }
      .pagination-btn.disabled { opacity: 0.5; cursor: not-allowed; }
      .pagination-info { color: var(--muted); font-size: 12px; }
      .autocomplete-container { min-width:260px; position:relative; }
      .autocomplete-input { width:100%; padding:8px 12px; border:1px solid var(--border); border-radius:8px; background: var(--bg); color: var(--text); font-size:14px; }
      .autocomplete-dropdown { position:absolute; top:100%; left:0; right:0; background:#1f2937 !important; border:1px solid #374151 !important; border-radius:8px; max-height:200px; overflow-y:auto; z-index:1000; margin-top:4px; }
      .autocomplete-option { padding:10px 12px; cursor:pointer; border-bottom:1px solid #374151; background:#1f2937; color:#f9fafb; }
      .autocomplete-option:last-child { border-bottom:none; }
      .list .item { padding:6px 10px; margin-bottom:6px; position:relative; }
      .title { font-size:13px; }
      .meta { font-size:12px; color: var(--muted); }
      table { width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed; }
      th, td { padding:3px 6px; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      colgroup col:nth-child(1) { width:30%; }
      colgroup col:nth-child(2) { width:35%; }
      colgroup col:nth-child(3) { width:35%; }
    </style>
  </head>
  <body>
    <div class="container">
      <a class="link" href="/group/{{ gid }}{% if request.query_params.get('tg_id') %}?tg_id={{ request.query_params.get('tg_id') }}{% endif %}">← К группе</a>
      <h2>Аудит: {{ group[2] if group else '' }}</h2>
      <form method="get" action="/group/{{ gid }}/audit" style="margin-bottom:8px; display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap;">
        <div class="autocomplete-container" id="gaEvent">
          <input class="autocomplete-input" type="text" id="gaEventInput" placeholder="Фильтр: мероприятие" value="" autocomplete="off">
          <input type="hidden" name="event_id" id="gaEventId" value="{{ event_filter or '' }}">
          <div class="autocomplete-dropdown" id="gaEventDd" style="display:none;">
            {% for eid, name in audit_events %}
              <div class="autocomplete-option" data-value="{{ eid }}">{{ name }} (#{{ eid }})</div>
            {% endfor %}
          </div>
        </div>
        <label>Показывать:
          <select name="per_page" style="padding: 6px 8px; border:1px solid var(--border); border-radius:6px; background: var(--card); color: var(--text);">
            <option value="20" {% if audit_per_page==20 %}selected{% endif %}>20</option>
            <option value="50" {% if audit_per_page==50 %}selected{% endif %}>50</option>
            <option value="100" {% if audit_per_page==100 %}selected{% endif %}>100</option>
            <option value="200" {% if audit_per_page==200 %}selected{% endif %}>200</option>
          </select>
        </label>
        <button class="btn" type="submit">Фильтр</button>
        <a class="btn" href="/group/{{ gid }}/audit" style="text-decoration:none;">Сброс</a>
      </form>

      {% if audit_items %}
        {% set total_pages = (audit_total + audit_per_page - 1) // audit_per_page %}
        <div class="pagination-container">
          <div>
            {% if audit_page > 1 %}
              <a class="pagination-btn" href="/group/{{ gid }}/audit?per_page={{ audit_per_page }}{% if event_filter %}&event_id={{ event_filter }}{% endif %}&page={{ audit_page - 1 }}">← Назад</a>
            {% else %}
              <span class="pagination-btn disabled">← Назад</span>
            {% endif %}
            {% if audit_page < total_pages %}
              <a class="pagination-btn" href="/group/{{ gid }}/audit?per_page={{ audit_per_page }}{% if event_filter %}&event_id={{ event_filter }}{% endif %}&page={{ audit_page + 1 }}">Вперед →</a>
            {% else %}
              <span class="pagination-btn disabled">Вперед →</span>
            {% endif %}
          </div>
          <div class="pagination-info">Страница {{ audit_page }} из {{ total_pages }} ({{ audit_total }} записей)</div>
        </div>

        <ul class="list">
          {% for row in audit_items %}
            <li class="item">
              <div class="title">{{ row.ts }} — {{ row.user_label or '—' }}</div>
              <div class="meta">Мероприятие: {% if row.event_name %}<a class="link" href="/group/{{ gid }}/events/{{ row.event_id }}/settings">{{ row.event_name }}</a> ({{ row.event_id }}){% else %}—{% endif %}</div>
              <div style="margin-top:4px;">
                <table>
                  <colgroup>
                    <col><col><col>
                  </colgroup>
                  <thead>
                    <tr style="color:var(--muted);">
                      <th>Что изменено</th>
                      <th>Старое</th>
                      <th>Новое</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>{{ row.action_ru or row.action }}</td>
                      <td>{{ row.old or '—' }}</td>
                      <td>{{ row.new or '—' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty">Записей нет</div>
      {% endif %}
    </div>

    <script>
      (function(){
        const wrap = document.getElementById('gaEvent');
        if (!wrap) return;
        const input = document.getElementById('gaEventInput');
        const hidden = document.getElementById('gaEventId');
        const dd = document.getElementById('gaEventDd');
        const opts = dd ? Array.from(dd.querySelectorAll('.autocomplete-option')) : [];

        function openDd(){ if (dd) dd.style.display = 'block'; }
        function closeDd(){ if (dd) dd.style.display = 'none'; }
        function filter(){
          const q = (input.value||'').toLowerCase();
          opts.forEach(o => { o.style.display = o.textContent.toLowerCase().includes(q) ? 'block' : 'none'; });
          openDd();
        }
        function select(o){ input.value = o.textContent; hidden.value = o.dataset.value; closeDd(); }

        if (input && dd){
          input.addEventListener('input', filter);
          input.addEventListener('focus', openDd);
          document.addEventListener('click', (e)=>{ if (!wrap.contains(e.target)) closeDd(); });
          opts.forEach(o => o.addEventListener('click', () => select(o)));
        }

        // Prefill visible input from current filter
        try {
          const cur = hidden.value;
          if (cur) {
            const found = opts.find(o => o.dataset.value === cur);
            if (found) input.value = found.textContent;
          }
        } catch(e) {}
      })();
    </script>
  </body>
</html>
