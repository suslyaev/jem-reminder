<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Событие — {{ event[1] if event else '' }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
      .tab-btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--card); color: var(--text); border-radius: 8px; cursor: pointer; }
      .tab-btn.active { background: var(--btn); color: #fff; }
      .tab-content { display: block; }
      .tab-content.hidden { display: none; }
      .switch-container { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; }
      .switch-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--card); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 14px; }
      .switch-btn.active { background: var(--btn); color: #fff; }
      .form-group { margin-bottom: 12px; }
      .form-row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; width: 100%; }
      .item { position: relative; }
      .delete-btn { position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; }
      .autocomplete-container { flex: 1 1 auto; min-width: 0; position: relative; }
      .autocomplete-input { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px; }
      .autocomplete-dropdown { position: absolute !important; top: 100% !important; left: 0 !important; right: 0 !important; background: #1f2937 !important; border: 1px solid #374151 !important; border-radius: 8px !important; max-height: 200px !important; overflow-y: auto !important; z-index: 1000 !important; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important; margin-top: 4px !important; opacity: 1 !important; }
      .autocomplete-option { padding: 8px 12px; cursor: pointer; color: var(--text); }
      .autocomplete-option:hover { background: #374151; }
      .autocomplete-option.highlighted { background: #374151; }
      .autocomplete-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #6b7280; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; display: none; align-items: center; justify-content: center; }
      .autocomplete-clear.show { display: flex; }
      .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 12px 20px; border-radius: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
    </style>
  </head>
  <body>
    <div class="container">
      <a class="link" href="/group/{{ group[0] }}{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">← К списку</a>
      <h2>{{ event[1] }}</h2>
      <div class="meta">{{ event_time_display }}</div>

      {% if request.query_params.get('ok') == 'updated' %}
        <div class="toast" style="background: #16a34a; color: #fff;">Настройки мероприятия сохранены</div>
      {% elif request.query_params.get('ok') == 'notification_added' %}
        <div class="toast" style="background: #16a34a; color: #fff;">Групповое оповещение добавлено</div>
      {% elif request.query_params.get('ok') == 'personal_notification_added' %}
        <div class="toast" style="background: #16a34a; color: #fff;">Личное оповещение добавлено</div>
      {% elif request.query_params.get('ok') == 'notification_in_past' %}
        <div class="toast" style="background: #ef4444; color: #fff;">Оповещение не может быть в прошлом</div>
      {% elif request.query_params.get('ok') == 'parse_error' %}
        <div class="toast" style="background: #ef4444; color: #fff;">Ошибка парсинга времени</div>
      {% elif request.query_params.get('ok') == 'event_not_found' %}
        <div class="toast" style="background: #ef4444; color: #fff;">Событие не найдено</div>
      {% endif %}

      <h3>Ответственный</h3>
      {% if role in ['admin', 'owner', 'superadmin'] %}
        <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/update{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
          <div class="form-row">
            <div class="autocomplete-container">
              <input class="autocomplete-input" type="text" placeholder="— ответственный —" 
                     value="{% if event[4] %}{{ members|selectattr('0', 'equalto', event[4])|map(attribute='1')|first }}{% endif %}"
                     data-user-id="{% if event[4] %}{{ event[4] }}{% else %}0{% endif %}"
                     autocomplete="off">
              <button type="button" class="autocomplete-clear" id="responsibleClear">✕</button>
              <input type="hidden" name="responsible_user_id" value="{% if event[4] %}{{ event[4] }}{% else %}0{% endif %}">
              <div class="autocomplete-dropdown" style="display: none;">
                <div class="autocomplete-option" data-value="0">— ответственный —</div>
              {% for uid, uname in members %}
                  <div class="autocomplete-option" data-value="{{ uid }}">{{ uname if uname else 'ID: ' + uid|string }}</div>
              {% endfor %}
              </div>
            </div>
            <button class="btn" type="submit">Сохранить</button>
          </div>
        </form>
      {% else %}
        {% if event[4] %}
          <div class="meta">Ответственный: {{ responsible_name or 'ID: ' + event[4]|string }}</div>
        {% else %}
          <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/book{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
            <button class="btn" type="submit">Забронировать</button>
          </form>
        {% endif %}
      {% endif %}

      <h3>Оповещения</h3>
      <div class="tabs">
        {% if role in ['admin', 'owner', 'superadmin'] %}
          <button class="tab-btn active" onclick="switchTab('group')" id="group-tab">Групповые</button>
        {% endif %}
        <button class="tab-btn {% if role not in ['admin', 'owner', 'superadmin'] %}active{% endif %}" onclick="switchTab('personal')" id="personal-tab">Личные</button>
      </div>

      <div id="group-notifications" class="tab-content {% if role not in ['admin', 'owner', 'superadmin'] %}hidden{% endif %}">
        {% if role in ['admin', 'owner', 'superadmin'] %}
          {% if not event_notifications %}
            <div class="empty">Пока нет групповых оповещений</div>
          {% else %}
            <ul class="list">
              {% for nid, time_before, time_unit, message_text in event_notifications %}
                <li class="item">
                  <div class="title">
                    {% set unit_map = {
                      'days': ['день', 'дня', 'дней'],
                      'hours': ['час', 'часа', 'часов'],
                      'minutes': ['минута', 'минуты', 'минут'],
                      'weeks': ['неделя', 'недели', 'недель'],
                      'months': ['месяц', 'месяца', 'месяцев']
                    } %}
                    {% set forms = unit_map.get(time_unit, ['', '', '']) %}
                    {% if time_before == 1 %}
                      {{ time_before }} {{ forms[0] }}
                    {% elif time_before in [2, 3, 4] %}
                      {{ time_before }} {{ forms[1] }}
                    {% else %}
                      {{ time_before }} {{ forms[2] }}
                    {% endif %}
                  </div>
                  <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 4px;">
                    Когда: {{ _calculate_notification_time(event[2], time_before, time_unit) }}
                  </div>
                  <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 2px;">
                    Текст: {{ message_text if message_text else '—' }}
                  </div>
                  <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/notifications/{{ nid }}/delete{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" style="position: absolute; top: 8px; right: 8px;">
                    <button type="submit" class="delete-btn">✕</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
          {% endif %}

          <h4>Добавить групповое оповещение</h4>
          <div class="switch-container">
            <button type="button" class="switch-btn active" onclick="switchAddMode('text')" id="text-mode">Текстом</button>
            <button type="button" class="switch-btn" onclick="switchAddMode('exact')" id="exact-mode">Точная дата</button>
          </div>

          <div id="text-add-form">
            <form id="group-text-form" method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/notifications/add-text{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" enctype="application/x-www-form-urlencoded">
              <input type="text" name="notification_text" placeholder="Например: за 1 день, за 2 часа, за 30 минут напомнить о встрече" required style="width: 100%; margin-bottom: 8px;" />
              <input type="text" name="message_text" placeholder="Сообщение (необязательно)" style="width: 100%; margin-bottom: 8px;" />
              <div style="display: flex; gap: 8px;">
                <button class="btn" type="submit" style="flex: 1;">Добавить</button>
                <button class="btn" type="button" onclick="clearForm('group-text-form')" style="background: #6b7280;">Очистить</button>
              </div>
            </form>
          </div>

          <div id="exact-add-form" style="display: none;">
            <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/notifications/add-absolute{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
              <input type="date" name="date" required style="width: 100%; margin-bottom: 8px;" />
              <input type="time" name="time" required style="width: 100%; margin-bottom: 8px;" />
              <input type="text" name="message_text" placeholder="Сообщение (необязательно)" style="width: 100%; margin-bottom: 8px;" />
              <button class="btn" type="submit">Добавить по дате</button>
            </form>
          </div>
        {% else %}
          <div class="empty">Групповые оповещения доступны только админам</div>
        {% endif %}
      </div>

      <div id="personal-notifications" class="tab-content {% if role in ['admin', 'owner', 'superadmin'] %}hidden{% endif %}">
        {% if not personal_notifications %}
          <div class="empty">Пока нет личных оповещений</div>
        {% else %}
          <ul class="list">
            {% for nid, time_before, time_unit, message_text in personal_notifications %}
              <li class="item">
                <div class="title">
                  {% set unit_map = {
                    'days': ['день', 'дня', 'дней'],
                    'hours': ['час', 'часа', 'часов'],
                    'minutes': ['минута', 'минуты', 'минут'],
                    'weeks': ['неделя', 'недели', 'недель'],
                    'months': ['месяц', 'месяца', 'месяцев']
                  } %}
                  {% set forms = unit_map.get(time_unit, ['', '', '']) %}
                  {% if time_before == 1 %}
                    {{ time_before }} {{ forms[0] }}
                  {% elif time_before in [2, 3, 4] %}
                    {{ time_before }} {{ forms[1] }}
                  {% else %}
                    {{ time_before }} {{ forms[2] }}
                  {% endif %}
                </div>
                <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 4px;">
                  Когда: {{ _calculate_notification_time(event[2], time_before, time_unit) }}
                </div>
                <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 2px;">
                  Текст: {{ message_text if message_text else '—' }}
                </div>
                <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/personal-notifications/{{ nid }}/delete{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" style="position: absolute; top: 8px; right: 8px;">
                  <button type="submit" class="delete-btn">✕</button>
                </form>
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        <h4>Добавить личное оповещение</h4>
        <div class="switch-container">
          <button type="button" class="switch-btn active" onclick="switchAddMode('text')" id="personal-text-mode">Текстом</button>
          <button type="button" class="switch-btn" onclick="switchAddMode('exact')" id="personal-exact-mode">Точная дата</button>
        </div>

        <div id="personal-text-add-form">
          <form id="personal-text-form" method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/personal-notifications/add-text{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" enctype="application/x-www-form-urlencoded">
            <input type="text" name="notification_text" placeholder="Например: за 1 день, за 2 часа, за 30 минут напомнить о встрече" required style="width: 100%; margin-bottom: 8px;" />
            <input type="text" name="message_text" placeholder="Сообщение (необязательно)" style="width: 100%; margin-bottom: 8px;" />
            <div style="display: flex; gap: 8px;">
              <button class="btn" type="submit" style="flex: 1;">Добавить</button>
              <button class="btn" type="button" onclick="clearForm('personal-text-form')" style="background: #6b7280;">Очистить</button>
            </div>
          </form>
        </div>

        <div id="personal-exact-add-form" style="display: none;">
          <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/personal-notifications/add-absolute{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
            <input type="date" name="date" required style="width: 100%; margin-bottom: 8px;" />
            <input type="time" name="time" required style="width: 100%; margin-bottom: 8px;" />
            <input type="text" name="message_text" placeholder="Сообщение (необязательно)" style="width: 100%; margin-bottom: 8px;" />
            <button class="btn" type="submit">Добавить по дате</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Add tg_id to all forms automatically
      function addTgIdToForms() {
        const tgId = new URLSearchParams(window.location.search).get('tg_id');
        if (tgId && tgId !== 'None') {
          const forms = document.querySelectorAll('form');
          forms.forEach(form => {
            // Check if form already has tg_id input
            if (!form.querySelector('input[name="tg_id"]')) {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'tg_id';
              input.value = tgId;
              form.appendChild(input);
            }
          });
        }
      }
      
      (function(){
        addTgIdToForms();
        
        const url = new URL(window.location.href);
        const ok = url.searchParams.get('ok');
        if (ok) {
          const map = { 
            updated: 'Настройки мероприятия сохранены',
            notification_added: 'Групповое оповещение добавлено', 
            personal_notification_added: 'Личное оповещение добавлено', 
            personal_notification_deleted: 'Личное оповещение удалено', 
            parse_error: 'Ошибка парсинга. Используйте формат: за 1 день, за 2 часа и т.д.', 
            event_booked: 'Мероприятие забронировано',
            booking_error: 'Ошибка бронирования',
            method_error: 'Ошибка: форма отправлена неправильным методом'
          };
          if (map[ok]) {
            // Remove the ok parameter from URL immediately
            url.searchParams.delete('ok');
            window.history.replaceState({}, '', url.toString());
            
            // Auto-hide toast after 3 seconds
            setTimeout(() => {
              const toast = document.querySelector('.toast');
              if (toast) {
                toast.style.display = 'none';
              }
            }, 3000);
          }
        }
      })();

      function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName + '-notifications').style.display = 'block';
        
        // Add active class to selected button
        document.getElementById(tabName + '-tab').classList.add('active');
      }

      function validateDateTimeForm(form) {
        const dateInput = form.querySelector('input[name="date"]');
        const timeInput = form.querySelector('input[name="time"]');
        
        if (!dateInput.value || !timeInput.value) {
          alert('Пожалуйста, выберите дату и время');
          return false;
        }
        
        // Проверяем, что дата в будущем
        const selectedDate = new Date(dateInput.value + 'T' + timeInput.value);
        const now = new Date();
        if (selectedDate <= now) {
          alert('Дата и время должны быть в будущем');
          return false;
        }
        
        return true;
      }

      // Prevent Safari form submission issues
      document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
          form.addEventListener('submit', function(e) {
            console.log('Form submitting:', form.action);
            
            // Clear form after submission to prevent Safari issues
            setTimeout(() => {
              form.reset();
            }, 100);
          });
        });

        // Initialize autocomplete for responsible user selection
        const autocompleteContainer = document.querySelector('.autocomplete-container');
        if (autocompleteContainer) {
          initAutocomplete(autocompleteContainer);
        }
      });

      function initAutocomplete(container) {
        const input = container.querySelector('.autocomplete-input');
        const hidden = container.querySelector('input[name="responsible_user_id"]');
        const dropdown = container.querySelector('.autocomplete-dropdown');
        const options = dropdown.querySelectorAll('.autocomplete-option');
        const clearBtn = container.querySelector('.autocomplete-clear');
        
        function updateClearButton() {
          if (clearBtn) {
            clearBtn.classList.toggle('show', input.value.trim() !== '');
          }
        }
        
        function clearInput() {
          input.value = '';
          hidden.value = '0';
          input.setAttribute('data-user-id', '0');
          dropdown.style.display = 'none';
          updateClearButton();
        }
        
        function filterOptions() {
          const query = input.value.toLowerCase();
          options.forEach(option => {
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(query) ? 'block' : 'none';
          });
          dropdown.style.display = 'block';
          updateClearButton();
        }
        
        function selectOption(option) {
          const value = option.getAttribute('data-value');
          const text = option.textContent;
          
          input.value = text;
          hidden.value = value;
          input.setAttribute('data-user-id', value);
          dropdown.style.display = 'none';
          updateClearButton();
        }
        
        // Show dropdown on focus
        input.addEventListener('focus', function() {
          filterOptions();
        });
        
        // Filter options on input
        input.addEventListener('input', filterOptions);
        
        // Handle clear button click
        if (clearBtn) {
          clearBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            clearInput();
          });
        }
        
        // Handle option selection
        options.forEach(option => {
          option.addEventListener('click', function() {
            selectOption(this);
          });
        });
        
        // Initialize clear button state
        updateClearButton();
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!container.contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });
        
        // Handle keyboard navigation
        input.addEventListener('keydown', function(e) {
          const visibleOptions = Array.from(options).filter(opt => opt.style.display !== 'none');
          const currentIndex = visibleOptions.findIndex(opt => opt.classList.contains('highlighted'));
          
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            const nextIndex = currentIndex < visibleOptions.length - 1 ? currentIndex + 1 : 0;
            visibleOptions.forEach(opt => opt.classList.remove('highlighted'));
            if (visibleOptions[nextIndex]) {
              visibleOptions[nextIndex].classList.add('highlighted');
            }
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : visibleOptions.length - 1;
            visibleOptions.forEach(opt => opt.classList.remove('highlighted'));
            if (visibleOptions[prevIndex]) {
              visibleOptions[prevIndex].classList.add('highlighted');
            }
          } else if (e.key === 'Enter') {
            e.preventDefault();
            const highlighted = visibleOptions.find(opt => opt.classList.contains('highlighted'));
            if (highlighted) {
              selectOption(highlighted);
            }
          } else if (e.key === 'Escape') {
            dropdown.style.display = 'none';
          }
        });
      }

      function clearForm(formId) {
        const form = document.getElementById(formId);
        if (form) {
          form.reset();
          console.log('Form cleared:', formId);
        }
      }

      function switchAddMode(mode) {
        // Switch for group notifications
        const groupTextForm = document.getElementById('text-add-form');
        const groupExactForm = document.getElementById('exact-add-form');
        const groupTextBtn = document.getElementById('text-mode');
        const groupExactBtn = document.getElementById('exact-mode');
        
        if (groupTextForm && groupExactForm && groupTextBtn && groupExactBtn) {
          if (mode === 'text') {
            groupTextForm.style.display = 'block';
            groupExactForm.style.display = 'none';
            groupTextBtn.classList.add('active');
            groupExactBtn.classList.remove('active');
          } else {
            groupTextForm.style.display = 'none';
            groupExactForm.style.display = 'block';
            groupTextBtn.classList.remove('active');
            groupExactBtn.classList.add('active');
          }
        }

        // Switch for personal notifications
        const personalTextForm = document.getElementById('personal-text-add-form');
        const personalExactForm = document.getElementById('personal-exact-add-form');
        const personalTextBtn = document.getElementById('personal-text-mode');
        const personalExactBtn = document.getElementById('personal-exact-mode');
        
        if (personalTextForm && personalExactForm && personalTextBtn && personalExactBtn) {
          if (mode === 'text') {
            personalTextForm.style.display = 'block';
            personalExactForm.style.display = 'none';
            personalTextBtn.classList.add('active');
            personalExactBtn.classList.remove('active');
          } else {
            personalTextForm.style.display = 'none';
            personalExactForm.style.display = 'block';
            personalTextBtn.classList.remove('active');
            personalExactBtn.classList.add('active');
          }
        }
      }
    </script>
  </body>
  </html>
