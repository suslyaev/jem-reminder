<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Событие — {{ event[1] if event else '' }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
      .tab-btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--card); color: var(--text); border-radius: 8px; cursor: pointer; }
      .tab-btn.active { background: var(--btn); color: #fff; }
      .tab-content { display: block; }
      .tab-content.hidden { display: none; }
      .switch-container { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; }
      .switch-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--card); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 14px; }
      .switch-btn.active { background: var(--btn); color: #fff; }
      .form-group { margin-bottom: 12px; }
      .form-row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; width: 100%; }
      .item { position: relative; }
      .delete-btn { position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; }
      .autocomplete-container { flex: 1 1 auto; min-width: 0; position: relative; }
      .autocomplete-input { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px; }
      .autocomplete-dropdown { position: absolute !important; top: 100% !important; left: 0 !important; right: 0 !important; background: #1f2937 !important; border: 1px solid #374151 !important; border-radius: 8px !important; max-height: 200px !important; overflow-y: auto !important; z-index: 1000 !important; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important; margin-top: 4px !important; opacity: 1 !important; }
      .autocomplete-option { padding: 8px 12px; cursor: pointer; color: var(--text); }
      .autocomplete-option:hover { background: #374151; }
      .autocomplete-option.highlighted { background: #374151; }
      .autocomplete-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #6b7280; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; display: none; align-items: center; justify-content: center; }
      .autocomplete-clear.show { display: flex; }
      .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 12px 20px; border-radius: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
    </style>
  </head>
  <body>
    <div class="container">
      <a class="link" href="/group/{{ group[0] }}{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">← К списку</a>
      <h2>{{ event[1] }}</h2>
      <div class="meta">{{ event_time_display }}</div>

      <div id="toast" class="toast" style="display: none;"></div>

      <!-- Блок Ответственный убран. Используем только блок Роли. -->

      {% if role in ['admin', 'owner', 'superadmin'] %}
      <div class="form-row" style="margin-top:12px; flex-direction: column; align-items: stretch; gap:8px;">
        <div style="display:flex; align-items:center; justify-content: space-between;">
          <label style="margin:0;">Роли</label>
          <label style="display:flex; align-items:center; gap:6px; font-weight: normal;">
            {% if template_row %}
              <input type="checkbox" form="tpl-update-form" name="allow_multi_roles_per_user" value="1" {% if (template_row[7] or 0) %}checked{% endif %}> Несколько ролей на человека
            {% else %}
              <form id="evt-roles-form" method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/roles/update{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
                <input type="checkbox" name="allow_multi_roles_per_user" value="1" {% if (event[5] or 0) %}checked{% endif %}> Несколько ролей на человека
              </form>
            {% endif %}
          </label>
        </div>
        <div id="rolesGrid" style="display:grid; grid-template-columns: 1fr 36px; gap:8px; align-items:center;">
          <div style="color:#9ca3af;">Название роли</div>
          <div></div>
          {% if template_row %}
            {% set roles = template_roles if template_roles else [] %}
          {% else %}
            {% set roles = event_roles if event_roles else [] %}
          {% endif %}
          {% if roles %}
            {% for rname, rreq in roles %}
              <input type="text" {% if template_row %}form="tpl-roles-form"{% else %}form="evt-roles-form"{% endif %} name="role_names" value="{{ rname }}" style="width:100%;">
              <button type="button" class="btn" onclick="removeRoleRow(this)" style="background:#ef4444; padding:4px 8px;">✕</button>
            {% endfor %}
          {% else %}
            <div style="grid-column: 1 / -1; color: #9ca3af; font-style: italic; padding: 8px 0;">Нет ролей. Нажмите "Добавить роль" чтобы создать.</div>
          {% endif %}
        </div>
        <div>
          <button type="button" class="btn" onclick="addRoleRow()">Добавить роль</button>
        </div>
        <div>
          {% if template_row %}
            <div style="margin-top:8px;"><button class="btn" type="submit" form="tpl-roles-form">Сохранить роли</button></div>
          {% else %}
            <div style="margin-top:8px;"><button class="btn" type="submit" form="evt-roles-form">Сохранить роли</button></div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Повторяемость (перенесено выше оповещений) -->
      {% if role in ['admin', 'owner', 'superadmin'] %}
      <hr style="margin: 16px 0; border-color: var(--border);">
      <h3>Повторяемость</h3>
      <style>
        .kind-switch { display: inline-flex; align-items: center; gap: 10px; margin: 8px 0 12px 0; }
        .switch { position: relative; width: 56px; height: 28px; background: #374151; border-radius: 999px; cursor: pointer; transition: background .2s; }
        .switch.on { background: #2563eb; }
        .switch-knob { position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: #fff; border-radius: 50%; transition: left .2s; }
        .switch.on .switch-knob { left: 31px; }
      </style>

      {% if template_row %}
        {% set tpl = template_row %}
        {% set tpl_kind = tpl[4] %}
        {% set tpl_freq = tpl[9] or '' %}
        {% set tpl_interval = tpl[10] or 1 %}
        {% set tpl_horizon = tpl[7] or 60 %}
        <div class="meta" style="margin-bottom:8px;">Шаблон: {{ 'Повторяющееся' if tpl_kind != 'one_time' else 'Разовое' }}; {% if tpl_kind != 'one_time' %}каждые {{ tpl_interval }} {% if tpl_freq == 'daily' %}дней{% elif tpl_freq == 'weekly' %}нед{% elif tpl_freq == 'monthly' %}мес{% else %}-{% endif %}; горизонт {{ tpl_horizon }} дн.{% endif %}</div>

        <!-- Форма для периодичности -->
        <form id="tpl-update-form" method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/template/update{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
          <div class="kind-switch">
            <span>Разовое</span>
            <div id="tplKindSwitch" class="switch {% if tpl_kind != 'one_time' %}on{% endif %}" tabindex="0" role="switch" aria-checked="{% if tpl_kind != 'one_time' %}true{% else %}false{% endif %}">
              <div class="switch-knob"></div>
            </div>
            <span>Повторяющееся</span>
          </div>
          <!-- Поля периодичности видимы только если включено Повторяющееся -->
          <div id="tplPeriodicity" class="form-row" style="margin-top:8px; {% if tpl_kind == 'one_time' %}display:none;{% endif %}">
            <label>Повторять каждый:</label>
            <input type="number" name="repeat_every" value="{{ tpl_interval }}" min="1" style="width: 80px;" form="tpl-update-form">
            <select name="repeat_unit" form="tpl-update-form">
              <option value="day" {% if tpl_freq == 'daily' %}selected{% endif %}>день</option>
              <option value="week" {% if tpl_freq == 'weekly' %}selected{% endif %}>неделю</option>
              <option value="month" {% if tpl_freq == 'monthly' %}selected{% endif %}>месяц</option>
            </select>
            <label>Горизонт (дней):</label>
            <input type="number" name="planning_horizon_days" value="{{ tpl_horizon }}" min="7" style="width: 100px;" form="tpl-update-form">
          </div>
          
          <div class="form-row" style="margin-top:8px; gap:8px;">
            <button class="btn" type="submit">Сохранить периодичность</button>
            <label style="display:flex; align-items:center; gap:6px;">
              <input type="checkbox" name="regenerate" value="1" form="tpl-update-form"> Перегенерировать будущие
            </label>
          </div>
        </form>
        
        <!-- Отдельная форма для ролей -->
        <form id="tpl-roles-form" method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/template/update{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
          <input type="hidden" name="roles_only" value="1">
        </form>
      {% else %}
        <!-- Нет шаблона: форма конвертации, по умолчанию Разовое -->
        <form id="tpl-convert-form" method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/convert-to-template{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" style="margin-top: 8px;">
          <input type="hidden" name="kind" value="one_time">
          <div class="kind-switch">
            <span>Разовое</span>
            <div id="newKindSwitch" class="switch" tabindex="0" role="switch" aria-checked="false">
              <div class="switch-knob"></div>
            </div>
            <span>Повторяющееся</span>
          </div>
          <div id="newPeriodicity" class="form-row" style="margin-top:8px; display:none;">
            <label>Повторять каждый:</label>
            <input type="number" name="repeat_every" value="1" min="1" style="width: 80px;">
            <select name="repeat_unit">
              <option value="day">день</option>
              <option value="week" selected>неделю</option>
              <option value="month">месяц</option>
            </select>
            <label>Горизонт (дней):</label>
            <input type="number" name="planning_horizon_days" value="60" min="7" style="width: 100px;">
            <label style="display:flex; align-items:center; gap:6px;">
              <input type="checkbox" name="allow_multi_roles_per_user" value="1"> Несколько ролей на человека
            </label>
          </div>
          <div class="form-row" style="margin-top:8px;">
            <button class="btn" type="submit">Сохранить</button>
          </div>
        </form>
      {% endif %}
      <script>
        (function(){
          const switchEl = document.getElementById('newKindSwitch');
          const periodicity = document.getElementById('newPeriodicity');
          const form = document.getElementById('tpl-convert-form');
          if (switchEl && periodicity && form) {
            const hiddenKind = form.querySelector('input[name="kind"]');
            const toggle = () => {
              const on = switchEl.classList.toggle('on');
              switchEl.setAttribute('aria-checked', on ? 'true' : 'false');
              periodicity.style.display = on ? 'flex' : 'none';
              hiddenKind.value = on ? 'recurring' : 'one_time';
            };
            switchEl.addEventListener('click', toggle);
            switchEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); }});
          }

          const tplSwitch = document.getElementById('tplKindSwitch');
          const tplPeriod = document.getElementById('tplPeriodicity');
          if (tplSwitch && tplPeriod) {
            const toggle2 = () => {
              const on = tplSwitch.classList.toggle('on');
              tplSwitch.setAttribute('aria-checked', on ? 'true' : 'false');
              tplPeriod.style.display = on ? 'flex' : 'none';
              // Примечание: смена one_time/recurring через update сейчас не меняет kind,
              // но скрытие полей соответствует UX-требованию. При необходимости можно
              // добавить отдельный эндпоинт, меняющий kind у шаблона.
            };
            tplSwitch.addEventListener('click', toggle2);
            tplSwitch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle2(); }});
          }

          // Roles dynamic rows
          window.addRoleRow = function() {
            const grid = document.getElementById('rolesGrid');
            if (!grid) return;
            
            // Убрать сообщение "Нет ролей" если оно есть
            const emptyMsg = grid.querySelector('div[style*="grid-column: 1 / -1"]');
            if (emptyMsg) {
              grid.removeChild(emptyMsg);
            }
            
            // Determine which form to bind inputs to
            const tplRolesForm = document.getElementById('tpl-roles-form');
            const evtForm = document.getElementById('evt-roles-form');
            const targetFormId = tplRolesForm ? 'tpl-roles-form' : (evtForm ? 'evt-roles-form' : null);
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.name = 'role_names';
            nameInput.style.width = '100%';
            nameInput.placeholder = 'Название роли';
            if (targetFormId) nameInput.setAttribute('form', targetFormId);

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'btn';
            delBtn.style.background = '#ef4444';
            delBtn.style.padding = '4px 8px';
            delBtn.textContent = '✕';
            delBtn.onclick = function(){ removeRoleRow(delBtn); };

            grid.appendChild(nameInput);
            grid.appendChild(delBtn);
          }

          window.removeRoleRow = function(btn) {
            const grid = document.getElementById('rolesGrid');
            if (!grid) return;
            const cell = btn;
            const nameInput = cell.previousElementSibling;
            if (nameInput) {
              grid.removeChild(nameInput);
              grid.removeChild(cell);
              
              // Если больше нет ролей, показать сообщение
              const remainingInputs = grid.querySelectorAll('input[name="role_names"]');
              if (remainingInputs.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = 'grid-column: 1 / -1; color: #9ca3af; font-style: italic; padding: 8px 0;';
                emptyMsg.textContent = 'Нет ролей. Нажмите "Добавить роль" чтобы создать.';
                grid.appendChild(emptyMsg);
              }
            }
          }
        })();
      </script>
      {% endif %}

      <h3>Оповещения</h3>
      <div class="tabs">
        {% if role in ['admin', 'owner', 'superadmin'] %}
          <button class="tab-btn {% if request.query_params.get('tab') != 'personal' %}active{% endif %}" onclick="switchTab('group')" id="group-tab">Групповые</button>
        {% endif %}
        <button class="tab-btn {% if request.query_params.get('tab') == 'personal' or role not in ['admin', 'owner', 'superadmin'] %}active{% endif %}" onclick="switchTab('personal')" id="personal-tab">Личные</button>
      </div>

      

      <div id="group-notifications" class="tab-content {% if request.query_params.get('tab') == 'personal' or role not in ['admin', 'owner', 'superadmin'] %}hidden{% endif %}">
        {% if role in ['admin', 'owner', 'superadmin'] %}
          {% if not event_notifications %}
            <div class="empty">Пока нет групповых оповещений</div>
          {% else %}
            <ul class="list">
              {% for nid, time_before, time_unit, message_text in event_notifications %}
                {% set is_sent = event_notifications_sent.get((time_before, time_unit), False) %}
                <li class="item {% if is_sent %}notification-sent{% endif %}">
                  <div class="title">
                    {% set unit_map = {
                      'days': ['день', 'дня', 'дней'],
                      'hours': ['час', 'часа', 'часов'],
                      'minutes': ['минута', 'минуты', 'минут'],
                      'weeks': ['неделя', 'недели', 'недель'],
                      'months': ['месяц', 'месяца', 'месяцев']
                    } %}
                    {% set forms = unit_map.get(time_unit, ['', '', '']) %}
                    {% if time_before == 1 %}
                      {{ time_before }} {{ forms[0] }}
                    {% elif time_before in [2, 3, 4] %}
                      {{ time_before }} {{ forms[1] }}
                    {% else %}
                      {{ time_before }} {{ forms[2] }}
                    {% endif %}
                    {% if is_sent %} ✓{% endif %}
                  </div>
                  <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 4px;">
                    Когда: {{ _calculate_notification_time(event[2], time_before, time_unit) }}
                  </div>
                  <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 2px;">
                    Куда: Группа (ID: {{ group[1] }})
                  </div>
                  <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 2px;">
                    Текст: {{ message_text if message_text else '—' }}
                  </div>
                  {% if not is_sent %}
                    <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/notifications/{{ nid }}/delete{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" style="position: absolute; top: 8px; right: 8px;" class="delete-btn">
                      <button type="submit" class="delete-btn">✕</button>
                    </form>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}

          <h4>Добавить групповое оповещение</h4>
          <div class="switch-container">
            <button type="button" class="switch-btn active" onclick="switchAddMode('text')" id="text-mode">Текстом</button>
            <button type="button" class="switch-btn" onclick="switchAddMode('exact')" id="exact-mode">Точная дата</button>
          </div>

          <div id="text-add-form">
            <form id="group-text-form" method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/notifications/add-text{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" enctype="application/x-www-form-urlencoded">
              <input type="text" name="notification_text" placeholder="Например: за 1 день, за 2 часа, за 30 минут напомнить о встрече" required style="width: 100%; margin-bottom: 8px;" />
              <input type="text" name="message_text" placeholder="Сообщение (необязательно)" style="width: 100%; margin-bottom: 8px;" />
              <button class="btn" type="submit">Добавить</button>
            </form>
          </div>

          <div id="exact-add-form" style="display: none;">
            <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/notifications/add-absolute{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
              <input type="datetime-local" name="datetime_str" required style="width: 100%; margin-bottom: 8px;" />
              <input type="text" name="message_text" placeholder="Сообщение (необязательно)" style="width: 100%; margin-bottom: 8px;" />
              <button class="btn" type="submit">Добавить</button>
            </form>
          </div>
        {% else %}
          <div class="empty">Групповые оповещения доступны только админам</div>
        {% endif %}
      </div>

      <div id="personal-notifications" class="tab-content {% if request.query_params.get('tab') != 'personal' and role in ['admin', 'owner', 'superadmin'] %}hidden{% endif %}">
        {% if not personal_notifications %}
          <div class="empty">Пока нет личных оповещений</div>
        {% else %}
          <ul class="list">
            {% for nid, time_before, time_unit, message_text in personal_notifications %}
              {% set is_sent = personal_notifications_sent.get((time_before, time_unit), False) %}
              <li class="item {% if is_sent %}notification-sent{% endif %}">
                <div class="title">
                  {% set unit_map = {
                    'days': ['день', 'дня', 'дней'],
                    'hours': ['час', 'часа', 'часов'],
                    'minutes': ['минута', 'минуты', 'минут'],
                    'weeks': ['неделя', 'недели', 'недель'],
                    'months': ['месяц', 'месяца', 'месяцев']
                  } %}
                  {% set forms = unit_map.get(time_unit, ['', '', '']) %}
                  {% if time_before == 1 %}
                    {{ time_before }} {{ forms[0] }}
                  {% elif time_before in [2, 3, 4] %}
                    {{ time_before }} {{ forms[1] }}
                  {% else %}
                    {{ time_before }} {{ forms[2] }}
                  {% endif %}
                  {% if is_sent %} ✓{% endif %}
                </div>
                <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 4px;">
                  Когда: {{ _calculate_notification_time(event[2], time_before, time_unit) }}
                </div>
                <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 2px;">
                  Куда: {{ current_user_display_name }} (ID: {{ current_user_telegram_id }})
                </div>
                <div class="subtitle" style="font-size: 0.8em; color: #9ca3af; margin-top: 2px;">
                  Текст: {{ message_text if message_text else '—' }}
                </div>
                {% if not is_sent %}
                  <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/personal-notifications/{{ nid }}/delete{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" style="position: absolute; top: 8px; right: 8px;" class="delete-btn">
                    <button type="submit" class="delete-btn">✕</button>
                  </form>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        <h4>Добавить личное оповещение</h4>
        <div class="switch-container">
          <button type="button" class="switch-btn active" onclick="switchAddMode('text')" id="personal-text-mode">Текстом</button>
          <button type="button" class="switch-btn" onclick="switchAddMode('exact')" id="personal-exact-mode">Точная дата</button>
        </div>

        <div id="personal-text-add-form">
          <form id="personal-text-form" method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/personal-notifications/add-text{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" enctype="application/x-www-form-urlencoded">
            <input type="text" name="notification_text" placeholder="Например: за 1 день, за 2 часа, за 30 минут напомнить о встрече" required style="width: 100%; margin-bottom: 8px;" />
            <input type="text" name="message_text" placeholder="Сообщение (необязательно)" style="width: 100%; margin-bottom: 8px;" />
            <button class="btn" type="submit">Добавить</button>
          </form>
        </div>

        <div id="personal-exact-add-form" style="display: none;">
          <form method="post" action="/group/{{ group[0] }}/events/{{ event[0] }}/personal-notifications/add-absolute{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
            <input type="datetime-local" name="datetime_str" required style="width: 100%; margin-bottom: 8px;" />
            <input type="text" name="message_text" placeholder="Сообщение (необязательно)" style="width: 100%; margin-bottom: 8px;" />
            <button class="btn" type="submit">Добавить</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Handle tab parameter from URL on page load
      document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        if (tab === 'personal') {
          switchTab('personal');
        } else if (tab === 'group') {
          switchTab('group');
        }
      });

      // Add tg_id to all forms automatically
      function addTgIdToForms() {
        const tgId = new URLSearchParams(window.location.search).get('tg_id');
        if (tgId && tgId !== 'None') {
          const forms = document.querySelectorAll('form');
          forms.forEach(form => {
            // Check if form already has tg_id input
            if (!form.querySelector('input[name="tg_id"]')) {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'tg_id';
              input.value = tgId;
              form.appendChild(input);
            }
          });
        }
      }
      
      (function(){
        addTgIdToForms();
        
        const url = new URL(window.location.href);
        const ok = url.searchParams.get('ok');
        if (ok) {
          const map = { 
            updated: 'Настройки мероприятия сохранены',
            notification_added: 'Групповое оповещение добавлено', 
            personal_notification_added: 'Личное оповещение добавлено', 
            personal_notification_updated: 'Личное оповещение обновлено',
            notification_deleted: 'Групповое уведомление удалено',
            personal_notification_deleted: 'Личное оповещение удалено', 
            parse_error: 'Ошибка парсинга. Используйте формат: за 1 день, за 2 часа и т.д.', 
            event_booked: 'Мероприятие забронировано',
            booking_error: 'Ошибка бронирования',
            method_error: 'Ошибка: форма отправлена неправильным методом'
          };
          if (map[ok]) {
            const toast = document.getElementById('toast');
            if (toast) {
              toast.textContent = map[ok];
              
              // Set color based on message type
              if (ok.includes('deleted') || ok.includes('error') || ok.includes('not_found') || ok.includes('in_past')) {
                toast.style.background = '#ef4444'; // Red for errors and deletions
              } else {
                toast.style.background = '#16a34a'; // Green for success
              }
              
              toast.style.display = 'block';
            }
            
            // Remove the ok parameter from URL immediately
            url.searchParams.delete('ok');
            window.history.replaceState({}, '', url.toString());
            
            // Auto-hide toast after 3 seconds
            setTimeout(() => {
              if (toast) {
                toast.style.display = 'none';
              }
            }, 3000);
          }
        }
      })();

      function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName + '-notifications').style.display = 'block';
        
        // Add active class to selected button
        document.getElementById(tabName + '-tab').classList.add('active');
      }

      function validateDateTimeForm(form) {
        const dateInput = form.querySelector('input[name="date"]');
        const timeInput = form.querySelector('input[name="time"]');
        
        if (!dateInput.value || !timeInput.value) {
          alert('Пожалуйста, выберите дату и время');
          return false;
        }
        
        // Проверяем, что дата в будущем
        const selectedDate = new Date(dateInput.value + 'T' + timeInput.value);
        const now = new Date();
        if (selectedDate <= now) {
          alert('Дата и время должны быть в будущем');
          return false;
        }
        
        return true;
      }

      // Prevent Safari form submission issues
      document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
          form.addEventListener('submit', function(e) {
            console.log('Form submitting:', form.action);
            
            // Clear form after submission to prevent Safari issues
            setTimeout(() => {
              form.reset();
            }, 100);
          });
        });

        // Initialize autocomplete for responsible user selection
        const autocompleteContainer = document.querySelector('.autocomplete-container');
        if (autocompleteContainer) {
          initAutocomplete(autocompleteContainer);
        }
      });

      function initAutocomplete(container) {
        const input = container.querySelector('.autocomplete-input');
        const hidden = container.querySelector('input[name="responsible_user_id"]');
        const dropdown = container.querySelector('.autocomplete-dropdown');
        const options = dropdown.querySelectorAll('.autocomplete-option');
        const clearBtn = container.querySelector('.autocomplete-clear');
        
        function updateClearButton() {
          if (clearBtn) {
            clearBtn.classList.toggle('show', input.value.trim() !== '');
          }
        }
        
        function clearInput() {
          input.value = '';
          hidden.value = '0';
          input.setAttribute('data-user-id', '0');
          dropdown.style.display = 'none';
          updateClearButton();
        }
        
        function filterOptions() {
          const query = input.value.toLowerCase();
          options.forEach(option => {
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(query) ? 'block' : 'none';
          });
          dropdown.style.display = 'block';
          updateClearButton();
        }
        
        function selectOption(option) {
          const value = option.getAttribute('data-value');
          const text = option.textContent;
          
          input.value = text;
          hidden.value = value;
          input.setAttribute('data-user-id', value);
          dropdown.style.display = 'none';
          updateClearButton();
        }
        
        // Show dropdown on focus
        input.addEventListener('focus', function() {
          filterOptions();
        });
        
        // Filter options on input
        input.addEventListener('input', filterOptions);
        
        // Handle clear button click
        if (clearBtn) {
          clearBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            clearInput();
          });
        }
        
        // Handle option selection
        options.forEach(option => {
          option.addEventListener('click', function() {
            selectOption(this);
          });
        });
        
        // Initialize clear button state
        updateClearButton();
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!container.contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });
        
        // Handle keyboard navigation
        input.addEventListener('keydown', function(e) {
          const visibleOptions = Array.from(options).filter(opt => opt.style.display !== 'none');
          const currentIndex = visibleOptions.findIndex(opt => opt.classList.contains('highlighted'));
          
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            const nextIndex = currentIndex < visibleOptions.length - 1 ? currentIndex + 1 : 0;
            visibleOptions.forEach(opt => opt.classList.remove('highlighted'));
            if (visibleOptions[nextIndex]) {
              visibleOptions[nextIndex].classList.add('highlighted');
            }
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : visibleOptions.length - 1;
            visibleOptions.forEach(opt => opt.classList.remove('highlighted'));
            if (visibleOptions[prevIndex]) {
              visibleOptions[prevIndex].classList.add('highlighted');
            }
          } else if (e.key === 'Enter') {
            e.preventDefault();
            const highlighted = visibleOptions.find(opt => opt.classList.contains('highlighted'));
            if (highlighted) {
              selectOption(highlighted);
            }
          } else if (e.key === 'Escape') {
            dropdown.style.display = 'none';
          }
        });
      }

      function clearForm(formId) {
        const form = document.getElementById(formId);
        if (form) {
          form.reset();
          console.log('Form cleared:', formId);
        }
      }

      function switchAddMode(mode) {
        // Switch for group notifications
        const groupTextForm = document.getElementById('text-add-form');
        const groupExactForm = document.getElementById('exact-add-form');
        const groupTextBtn = document.getElementById('text-mode');
        const groupExactBtn = document.getElementById('exact-mode');
        
        if (groupTextForm && groupExactForm && groupTextBtn && groupExactBtn) {
          if (mode === 'text') {
            groupTextForm.style.display = 'block';
            groupExactForm.style.display = 'none';
            groupTextBtn.classList.add('active');
            groupExactBtn.classList.remove('active');
          } else {
            groupTextForm.style.display = 'none';
            groupExactForm.style.display = 'block';
            groupTextBtn.classList.remove('active');
            groupExactBtn.classList.add('active');
          }
        }

        // Switch for personal notifications
        const personalTextForm = document.getElementById('personal-text-add-form');
        const personalExactForm = document.getElementById('personal-exact-add-form');
        const personalTextBtn = document.getElementById('personal-text-mode');
        const personalExactBtn = document.getElementById('personal-exact-mode');
        
        if (personalTextForm && personalExactForm && personalTextBtn && personalExactBtn) {
          if (mode === 'text') {
            personalTextForm.style.display = 'block';
            personalExactForm.style.display = 'none';
            personalTextBtn.classList.add('active');
            personalExactBtn.classList.remove('active');
          } else {
            personalTextForm.style.display = 'none';
            personalExactForm.style.display = 'block';
            personalTextBtn.classList.remove('active');
            personalExactBtn.classList.add('active');
          }
        }
      }
    </script>
  </body>
  </html>
