<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>{{ group[2] if group else ('–ì—Ä—É–ø–ø–∞ ' ~ group[0]) }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      .event-card { position: relative; padding: 12px 44px 12px 12px; border-radius: 12px; background: var(--card); margin-bottom: 12px; }
      .event-card .actions { width: 100%; }
      .event-head { display:flex; align-items: baseline; justify-content: space-between; gap: 12px; }
      .event-title { font-weight: 700; font-size: 16px; }
      .event-date { color: var(--muted); font-size: 14px; }
      .gear { position:absolute; top: 10px; right: 10px; text-decoration:none; }
      .row { display: flex; gap: 8px; align-items: center; width: 100%; }
      .row .name-input { flex: 1 1 auto; min-width: 0; width: 100%; }
      .row .time-input { flex: 1 1 auto; min-width: 180px; max-width: 220px; width: 100%; }
      .actions { display:flex; gap:8px; margin-top: 8px; align-items: center; flex-wrap: wrap; }
      .responsible { color: var(--muted); font-size: 13px; margin-top: 6px; }
      .select { min-width: 180px; }
      .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 12px 20px; border-radius: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); background: #16a34a; color: #fff; display: none; }
      .meta-line { color: var(--muted); font-size: 14px; margin-top: 4px; }
      .group-header { display: flex; align-items: center; justify-content: space-between; }
      .group-gear { text-decoration: none; }
      .row-actions { display:flex; align-items:center; gap:8px; margin-top:6px; }
      .btn-small { padding: 8px 10px; border-radius: 8px; background: var(--danger); color:#fff; border:0; cursor:pointer; }
      .autocomplete-container { flex: 1 1 auto; min-width: 180px; position: relative; }
      .autocomplete-input { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px; }
      .autocomplete-dropdown { position: absolute !important; top: 100% !important; left: 0 !important; right: 0 !important; background: #1f2937 !important; border: 1px solid #374151 !important; border-radius: 8px !important; max-height: 200px !important; overflow-y: auto !important; z-index: 1000 !important; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important; margin-top: 4px !important; opacity: 1 !important; }
      .autocomplete-option { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #374151; background: #1f2937 !important; color: #f9fafb !important; }
      .autocomplete-option:hover { background: #374151 !important; }
      .autocomplete-option:last-child { border-bottom: none; }
      
      .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
      .modal-content { background-color: #1f2937 !important; margin: 15% auto; padding: 0; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important; opacity: 1 !important; }
      .modal-header { padding: 16px 20px; border-bottom: 1px solid #374151 !important; display: flex; justify-content: space-between; align-items: center; }
      .modal-header h3 { margin: 0; color: #f9fafb !important; }
      .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #f9fafb !important; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
      .modal-body { padding: 20px; }
      .modal-footer { padding: 16px 20px; border-top: 1px solid #374151 !important; display: flex; gap: 8px; justify-content: flex-end; }
      .message-btn:hover { background: #2563eb !important; }
      #groupMessageText { width: 300px !important; }
      .search-container {
        position: relative;
        display: flex;
        align-items: flex-start;
        padding: 12px 44px 12px 12px;
        border-radius: 12px;
        background: var(--card);
        margin-bottom: 12px;
      }
      .search-box {
        width: 100%;
        padding: 0;
        border: none;
        border-radius: 0;
        background: transparent;
        color: var(--text);
        font-size: 16px;
        outline: none;
      }
      .search-clear {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 16px;
        padding: 4px;
        display: none;
      }
      .search-clear:hover {
        color: var(--text);
      }
      .search-clear.show {
        display: block;
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
      .tabs-container {
        margin-bottom: 20px;
      }
      
      .tabs-header {
        display: flex;
        border-bottom: 2px solid var(--border);
        margin-bottom: 16px;
      }
      
      .tab-btn {
        background: none;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: var(--muted);
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
      }
      
      .tab-btn:hover {
        color: var(--text);
      }
      
      .tab-btn.active {
        color: var(--text);
        border-bottom-color: var(--primary);
      }
      
      .tab-content {
        display: block;
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π */
      .archived-event {
        opacity: 0.7;
        background: #374151 !important;
      }
      
      .archived-event .event-title a {
        color: #9ca3af !important;
      }
      
      .archived-event .event-date {
        color: #6b7280 !important;
      }
      
      .archived-event .responsible {
        color: #6b7280 !important;
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
      .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        padding: 12px 0;
        border-top: 1px solid var(--border);
      }
      
      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .pagination-btn {
        padding: 6px 12px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      
      .pagination-btn:hover:not(.disabled) {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      
      .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .pagination-info {
        color: var(--muted);
        font-size: 14px;
      }
      
      .per-page-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }
      
      .per-page-selector select {
        padding: 4px 8px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: 4px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="toast" class="toast"></div>
      <a class="link" href="/{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">‚Üê –ù–∞–∑–∞–¥</a>
      <div class="group-header">
        <h2>{{ group[2] if group else '' }}</h2>
        {% if is_admin %}
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="message-btn" onclick="openGroupMessageModal()" style="background: #3b82f6; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">‚úâÔ∏è</button>
            <a class="group-gear" href="/group/{{ group[0] }}/settings{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</a>
          </div>
        {% endif %}
      </div>
      <div class="meta-line">#{{ group[0] }}</div>
      <div class="meta-line">{{ group[1] }}</div>
      <div class="meta-line">–†–æ–ª—å: {{ role }}</div>
      <div class="meta-line">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: {{ event_count }}</div>

      <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-btn {% if active_tab == 'active' %}active{% endif %}" id="active-tab" onclick="switchEventTab('active')">
            –ê–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ({{ active_pagination.total_items }})
          </button>
          <button class="tab-btn {% if active_tab == 'archived' %}active{% endif %}" id="archived-tab" onclick="switchEventTab('archived')">
            –ê—Ä—Ö–∏–≤ ({{ archived_pagination.total_items }})
          </button>
        </div>
        
        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
        <div class="tab-content" id="active-events" {% if active_tab != 'active' %}style="display: none;"{% endif %}>
          {% if not active_events %}
            <div class="empty">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
          {% else %}
            <div>
              <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
              {% if active_pagination.total_pages > 1 %}
                <div class="pagination-container">
                  <div class="pagination-controls">
                    {% if active_pagination.has_prev %}
                      <a href="/group/{{ group[0] }}?page={{ active_pagination.current_page - 1 }}&per_page={{ per_page }}{% if request.query_params.get('tg_id') | safe_tg_id %}&tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" class="pagination-btn">‚Üê –ù–∞–∑–∞–¥</a>
                    {% else %}
                      <span class="pagination-btn disabled">‚Üê –ù–∞–∑–∞–¥</span>
                    {% endif %}
                    
                    <span class="pagination-info">
                      –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ active_pagination.current_page }} –∏–∑ {{ active_pagination.total_pages }}
                      ({{ active_pagination.total_items }} –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π)
                    </span>
                    
                    {% if active_pagination.has_next %}
                      <a href="/group/{{ group[0] }}?page={{ active_pagination.current_page + 1 }}&per_page={{ per_page }}{% if request.query_params.get('tg_id') | safe_tg_id %}&tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" class="pagination-btn">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
                    {% else %}
                      <span class="pagination-btn disabled">–í–ø–µ—Ä–µ–¥ ‚Üí</span>
                    {% endif %}
                  </div>
                  
                  <div class="per-page-selector">
                    <label for="activePerPage">–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å:</label>
                    <select id="activePerPage" onchange="changePerPage(this.value, 'active')">
                      <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                      <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                      <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                      <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    </select>
                  </div>
                </div>
              {% endif %}
              
              <div class="search-container">
                <input type="text" id="eventSearch" class="search-box" placeholder="üîç –ü–æ–∏—Å–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π..." />
                <button type="button" id="eventSearchClear" class="search-clear">‚úï</button>
              </div>
              <div id="eventsList">
                {% for e in active_events %}
              <div class="event-card" data-name="{{ e.name.lower() }}" data-date="{{ e.time_display.lower() }}" data-responsible="{{ e.responsible_name.lower() if e.responsible_name else '' }}">
                <div class="event-head">
                  <div class="event-title"><a class="link" href="/group/{{ group[0] }}/events/{{ e.id }}{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" style="text-decoration:none;">{{ e.name }}</a></div>
                  <div class="event-date">{{ e.time_display }}</div>
                </div>
                {% if e.responsible_name %}
                  <div class="responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: {{ e.responsible_name }}</div>
                {% endif %}
              {% if is_admin %}
                <a class="gear" href="/group/{{ group[0] }}/events/{{ e.id }}/settings{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π">üîî</a>
                <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/update-from-card{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" style="margin-top:8px;">
                  <div class="row">
                    <input class="name-input" type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="{{ e.name }}" />
                    <input class="time-input" type="datetime-local" name="time" value="{{ e.time_input }}" />
                  </div>
                  <div class="actions">
                    {% if member_options and member_options|length > 0 %}
                      <div class="autocomplete-container">
                        <input class="autocomplete-input" type="text" placeholder="‚Äî –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π ‚Äî" 
                               value="{% if e.responsible_user_id %}{{ member_options|selectattr('0', 'equalto', e.responsible_user_id)|map(attribute='1')|first }}{% endif %}"
                               data-user-id="{% if e.responsible_user_id %}{{ e.responsible_user_id }}{% else %}0{% endif %}"
                               autocomplete="off">
                        <input type="hidden" name="responsible_user_id" value="{% if e.responsible_user_id %}{{ e.responsible_user_id }}{% else %}0{% endif %}">
                        <div class="autocomplete-dropdown" style="display: none;">
                          <div class="autocomplete-option" data-value="0">‚Äî –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π ‚Äî</div>
                          {% for uid, label in member_options %}
                            <div class="autocomplete-option" data-value="{{ uid }}">{{ label }}</div>
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                  </div>
                  <div class="actions" style="justify-content: flex-end; margin-top: 8px; margin-right: -8px;">
                    {% if not e.responsible_user_id and not e.has_any_bookings %}
                      <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/book" style="display: inline;">
                        <button class="btn" type="submit">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                      </form>
                    {% elif e.id in booked_ids %}
                      <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/unbook" style="display: inline;">
                        <button class="btn" type="submit" style="background: var(--danger);">–°–Ω—è—Ç—å –±—Ä–æ–Ω—å</button>
                      </form>
                    {% endif %}
                    <button class="btn" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/delete" style="display: inline;">
                      <button class="btn" type="submit" style="background: var(--danger);">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                  </div>
                </form>
              {% else %}
                {% set bookings = bookings_map.get(e.id, []) %}
                {% if bookings %}
                  <div class="meta-line" style="margin-top:6px;">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏: 
                    {% for uid, nm in bookings %}
                      {{ nm }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="actions" style="justify-content: flex-end; margin-top: 8px;">
                  {% if e.id in booked_ids %}
                    <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/unbook?tg_id={{ request.query_params.get('tg_id') }}" style="display: inline;">
                      <button class="btn" type="submit" style="background: var(--danger);">–°–Ω—è—Ç—å –±—Ä–æ–Ω—å</button>
                    </form>
                  {% else %}
                    {% if not e.has_any_bookings %}
                      <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/book" style="display: inline;">
                        <button class="btn" type="submit">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                      </form>
                    {% endif %}
                  {% endif %}
                </div>
              {% endif %}
            </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
        
        <!-- –ê—Ä—Ö–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
        <div class="tab-content" id="archived-events" {% if active_tab != 'archived' %}style="display: none;"{% endif %}>
          {% if not archived_events %}
            <div class="empty">–ù–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
          {% else %}
            <div>
              <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
              {% if archived_pagination.total_pages > 1 %}
                <div class="pagination-container">
                  <div class="pagination-controls">
                    {% if archived_pagination.has_prev %}
                      <a href="/group/{{ group[0] }}?page={{ archived_pagination.current_page - 1 }}&per_page={{ per_page }}&tab=archived{% if request.query_params.get('tg_id') | safe_tg_id %}&tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" class="pagination-btn">‚Üê –ù–∞–∑–∞–¥</a>
                    {% else %}
                      <span class="pagination-btn disabled">‚Üê –ù–∞–∑–∞–¥</span>
                    {% endif %}
                    
                    <span class="pagination-info">
                      –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ archived_pagination.current_page }} –∏–∑ {{ archived_pagination.total_pages }}
                      ({{ archived_pagination.total_items }} –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π)
                    </span>
                    
                    {% if archived_pagination.has_next %}
                      <a href="/group/{{ group[0] }}?page={{ archived_pagination.current_page + 1 }}&per_page={{ per_page }}&tab=archived{% if request.query_params.get('tg_id') | safe_tg_id %}&tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" class="pagination-btn">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
                    {% else %}
                      <span class="pagination-btn disabled">–í–ø–µ—Ä–µ–¥ ‚Üí</span>
                    {% endif %}
                  </div>
                  
                  <div class="per-page-selector">
                    <label for="archivedPerPage">–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å:</label>
                    <select id="archivedPerPage" onchange="changePerPage(this.value, 'archived')">
                      <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                      <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                      <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                      <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    </select>
                  </div>
                </div>
              {% endif %}
              
              <div class="search-container">
                <input type="text" id="archivedEventSearch" class="search-box" placeholder="üîç –ü–æ–∏—Å–∫ –≤ –∞—Ä—Ö–∏–≤–µ..." />
                <button type="button" id="archivedEventSearchClear" class="search-clear">‚úï</button>
              </div>
              <div id="archivedEventsList">
                {% for e in archived_events %}
              <div class="event-card archived-event" data-name="{{ e.name.lower() }}" data-date="{{ e.time_display.lower() }}" data-responsible="{{ e.responsible_name.lower() if e.responsible_name else '' }}">
                <div class="event-head">
                  <div class="event-title"><a class="link" href="/group/{{ group[0] }}/events/{{ e.id }}{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" style="text-decoration:none;">{{ e.name }}</a></div>
                  <div class="event-date">{{ e.time_display }}</div>
                </div>
                {% if e.responsible_name %}
                  <div class="responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: {{ e.responsible_name }}</div>
                {% endif %}
              {% if is_admin %}
                <a class="gear" href="/group/{{ group[0] }}/events/{{ e.id }}/settings{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π">üîî</a>
                <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/update-from-card{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" style="margin-top:8px;">
                  <div class="row">
                    <input class="name-input" type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="{{ e.name }}" />
                    <input class="time-input" type="datetime-local" name="time" value="{{ e.time_input }}" />
                  </div>
                  <div class="actions">
                    {% if member_options and member_options|length > 0 %}
                      <div class="autocomplete-container">
                        <input class="autocomplete-input" type="text" placeholder="‚Äî –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π ‚Äî" 
                               value="{% if e.responsible_user_id %}{{ member_options|selectattr('0', 'equalto', e.responsible_user_id)|map(attribute='1')|first }}{% endif %}"
                               data-user-id="{% if e.responsible_user_id %}{{ e.responsible_user_id }}{% else %}0{% endif %}"
                               autocomplete="off">
                        <input type="hidden" name="responsible_user_id" value="{% if e.responsible_user_id %}{{ e.responsible_user_id }}{% else %}0{% endif %}">
                        <div class="autocomplete-dropdown" style="display: none;">
                          <div class="autocomplete-option" data-value="0">‚Äî –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π ‚Äî</div>
                          {% for uid, label in member_options %}
                            <div class="autocomplete-option" data-value="{{ uid }}">{{ label }}</div>
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                  </div>
                  <div class="actions" style="justify-content: flex-end; margin-top: 8px; margin-right: -8px;">
                    <button class="btn" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/delete" style="display: inline;">
                      <button class="btn" type="submit" style="background: var(--danger);">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                  </div>
                </form>
              {% else %}
                {% set bookings = bookings_map.get(e.id, []) %}
                {% if bookings %}
                  <div class="meta-line" style="margin-top:6px;">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏: 
                    {% for uid, nm in bookings %}
                      {{ nm }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              {% endif %}
            </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      {% if is_admin %}
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h3>
        <form id="bulkForm" method="post" action="/group/{{ group[0] }}/events/create-multiple{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
          <div id="rows"></div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="btn" type="button" id="addRow">Ôºã –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
            <button class="btn" type="submit">–°–æ–∑–¥–∞—Ç—å</button>
          </div>
        </form>
        <script>
          (function(){
            const rows = document.getElementById('rows');
            const addRowBtn = document.getElementById('addRow');
            
            function initAutocomplete(container) {
              const input = container.querySelector('.autocomplete-input');
              const hidden = container.querySelector('input[name="responsible_user_id"]');
              const dropdown = container.querySelector('.autocomplete-dropdown');
              const options = dropdown.querySelectorAll('.autocomplete-option');
              
              function filterOptions() {
                const query = input.value.toLowerCase();
                options.forEach(option => {
                  const text = option.textContent.toLowerCase();
                  option.style.display = text.includes(query) ? 'block' : 'none';
                });
                dropdown.style.display = 'block';
              }
              
              function selectOption(option) {
                input.value = option.textContent;
                hidden.value = option.dataset.value;
                dropdown.style.display = 'none';
              }
              
              input.addEventListener('input', filterOptions);
              input.addEventListener('focus', () => dropdown.style.display = 'block');
              
              options.forEach(option => {
                option.addEventListener('click', () => selectOption(option));
              });
              
              document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                  dropdown.style.display = 'none';
                }
              });
            }
            
            function makeRow() {
              const wrap = document.createElement('div');
              wrap.className = 'item';
              wrap.innerHTML = `
                <div class=\"row\">
                  <input class=\"name-input\" type=\"text\" name=\"name\" placeholder=\"–ù–∞–∑–≤–∞–Ω–∏–µ\" />
                  <input class=\"time-input\" type=\"datetime-local\" name=\"time\" />
                  <button type=\"button\" class=\"del-row\" style=\"background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-left: 8px;\">‚úï</button>
                </div>
              `;
              return wrap;
            }
            
            function addRow() { 
              const row = makeRow();
              rows.appendChild(row);
              updateDeleteButtons();
              // Initialize autocomplete for existing dropdowns
              document.querySelectorAll('.autocomplete-container').forEach(initAutocomplete);
            }
            
            function updateDeleteButtons() {
              const items = rows.querySelectorAll('.item');
              items.forEach((item, index) => {
                const delBtn = item.querySelector('.del-row');
                if (delBtn) {
                  // Hide delete button for first row, show for others
                  delBtn.style.display = index === 0 ? 'none' : 'inline-block';
                }
              });
            }
            
            addRowBtn.addEventListener('click', addRow);
            rows.addEventListener('click', function(e){
              const btn = e.target.closest('.del-row');
              if (!btn) return;
              const item = btn.closest('.item');
              if (item) {
                item.remove();
                updateDeleteButtons();
              }
            });
            
            // Initialize autocomplete for existing dropdowns
            document.querySelectorAll('.autocomplete-container').forEach(initAutocomplete);
            
            // Note: Removed automatic tab movement on date change
            // Events will only move between tabs after form submission
            
            // start with one row
            addRow();
            updateDeleteButtons();
          })();
          
          // Event search functionality
          (function() {
            const searchInput = document.getElementById('eventSearch');
            const searchClear = document.getElementById('eventSearchClear');
            const eventsList = document.getElementById('eventsList');
            
            if (searchInput && eventsList) {
              function updateEventSearch() {
                const query = searchInput.value.toLowerCase().trim();
                const events = eventsList.querySelectorAll('.event-card');
                
                events.forEach(event => {
                  const name = event.getAttribute('data-name') || '';
                  const date = event.getAttribute('data-date') || '';
                  const responsible = event.getAttribute('data-responsible') || '';
                  
                  const matches = name.includes(query) || 
                                date.includes(query) || 
                                responsible.includes(query);
                  
                  event.style.display = matches ? 'block' : 'none';
                });
                
                // Show/hide clear button
                if (searchClear) {
                  searchClear.classList.toggle('show', query.length > 0);
                }
                
                // Hide pagination when searching
                const pagination = eventsList.parentElement.querySelector('.pagination-container');
                if (pagination) {
                  pagination.style.display = query.length > 0 ? 'none' : 'flex';
                }
              }
              
              searchInput.addEventListener('input', updateEventSearch);
              
              if (searchClear) {
                searchClear.addEventListener('click', function() {
                  searchInput.value = '';
                  updateEventSearch();
                  searchInput.focus();
                });
              }
            }
          })();
          
          // Archived events search functionality
          (function() {
            const searchInput = document.getElementById('archivedEventSearch');
            const searchClear = document.getElementById('archivedEventSearchClear');
            const eventsList = document.getElementById('archivedEventsList');
            
            if (searchInput && eventsList) {
              function updateArchivedEventSearch() {
                const query = searchInput.value.toLowerCase().trim();
                const events = eventsList.querySelectorAll('.event-card');
                
                events.forEach(event => {
                  const name = event.getAttribute('data-name') || '';
                  const date = event.getAttribute('data-date') || '';
                  const responsible = event.getAttribute('data-responsible') || '';
                  
                  const matches = name.includes(query) || 
                                date.includes(query) || 
                                responsible.includes(query);
                  
                  event.style.display = matches ? 'block' : 'none';
                });
                
                // Show/hide clear button
                if (searchClear) {
                  searchClear.classList.toggle('show', query.length > 0);
                }
                
                // Hide pagination when searching
                const pagination = eventsList.parentElement.querySelector('.pagination-container');
                if (pagination) {
                  pagination.style.display = query.length > 0 ? 'none' : 'flex';
                }
              }
              
              searchInput.addEventListener('input', updateArchivedEventSearch);
              
              if (searchClear) {
                searchClear.addEventListener('click', function() {
                  searchInput.value = '';
                  updateArchivedEventSearch();
                  searchInput.focus();
                });
              }
            }
          })();
        </script>
      {% endif %}
    </div>

    <!-- Group Message Modal -->
    <div id="groupMessageModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É</h3>
          <button class="close-btn" onclick="closeGroupMessageModal()">&times;</button>
        </div>
        <div class="modal-body">
          <textarea id="groupMessageText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã..." rows="4" style="width: 100%; padding: 8px; border: 1px solid #374151 !important; border-radius: 4px; resize: vertical; font-family: inherit; background: #1f2937 !important; color: #f9fafb !important;"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="sendGroupMessage()" style="background: #3b82f6;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <button class="btn" onclick="closeGroupMessageModal()" style="background: #6b7280;">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>

    <script>
      // Add tg_id, tab, and pagination parameters to all forms automatically
      function addTgIdToForms() {
        const urlParams = new URLSearchParams(window.location.search);
        const tgId = urlParams.get('tg_id');
        const currentTab = urlParams.get('tab') || 'active';
        const currentPage = urlParams.get('page') || '1';
        const perPage = urlParams.get('per_page') || '10';
        
        // Remove all existing pagination and tab inputs first
        document.querySelectorAll('input[name="tab"], input[name="page"], input[name="per_page"]').forEach(input => {
          input.remove();
        });
        
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
          // Add tg_id if not present
          if (tgId && tgId !== 'None' && !form.querySelector('input[name="tg_id"]')) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'tg_id';
            input.value = tgId;
            form.appendChild(input);
          }
          
          // Add pagination parameters
          const pageInput = document.createElement('input');
          pageInput.type = 'hidden';
          pageInput.name = 'page';
          pageInput.value = currentPage;
          form.appendChild(pageInput);
          
          const perPageInput = document.createElement('input');
          perPageInput.type = 'hidden';
          perPageInput.name = 'per_page';
          perPageInput.value = perPage;
          form.appendChild(perPageInput);
          
          // Add tab parameter only to forms in the currently visible tab
          const isInActiveTab = form.closest('#active-events');
          const isInArchivedTab = form.closest('#archived-events');
          
          if (currentTab === 'archived' && isInArchivedTab) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'tab';
            input.value = 'archived';
            form.appendChild(input);
          } else if (currentTab === 'active' && isInActiveTab) {
            // For active tab, we don't add tab parameter (it's the default)
            // But we ensure no tab parameter exists
          }
        });
      }
      
      (function(){
        addTgIdToForms();
        
        const url = new URL(window.location.href);
        const ok = url.searchParams.get('ok');
        if (ok) {
          const toast = document.getElementById('toast');
          const map = { created: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ', updated: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', event_updated: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω—ã', booked: '–ë—Ä–æ–Ω—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞', unbooked: '–ë—Ä–æ–Ω—å —Å–Ω—è—Ç–∞', name_saved: '–ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', noop: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è', event_deleted: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ', event_booked: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ', booking_error: '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è' };
          toast.textContent = map[ok] || '–ì–æ—Ç–æ–≤–æ';
          
          // Set color based on message type
          if (ok.includes('deleted') || ok.includes('error') || ok.includes('not_found') || ok.includes('in_past')) {
            toast.style.background = '#ef4444'; // Red for errors and deletions
          } else {
            toast.style.background = '#16a34a'; // Green for success
          }
          
          toast.style.display = 'block';
          url.searchParams.delete('ok');
          window.history.replaceState({}, '', url.toString());
          
          // Auto-hide toast after 3 seconds
          setTimeout(() => {
            if (toast) {
              toast.style.display = 'none';
            }
          }, 3000);
        }
      })();

      // Function to switch between event tabs
      function switchEventTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show selected tab content
        if (tabName === 'active') {
          document.getElementById('active-events').style.display = 'block';
          document.getElementById('active-tab').classList.add('active');
        } else if (tabName === 'archived') {
          document.getElementById('archived-events').style.display = 'block';
          document.getElementById('archived-tab').classList.add('active');
        }
        
        // Update URL with tab parameter
        const url = new URL(window.location.href);
        if (tabName === 'active') {
          url.searchParams.delete('tab');
        } else {
          url.searchParams.set('tab', tabName);
        }
        window.history.replaceState({}, '', url.toString());
        
        // Re-add form parameters for the new tab
        addTgIdToForms();
      }

      // Note: Removed checkEventTabMovement function
      // Events will only move between tabs after form submission and page reload

      // Function to update tab counts
      function updateTabCounts() {
        // Get total counts from pagination info
        const activePaginationInfo = document.querySelector('#active-events .pagination-info');
        const archivedPaginationInfo = document.querySelector('#archived-events .pagination-info');
        
        const activeTab = document.getElementById('active-tab');
        const archivedTab = document.getElementById('archived-tab');
        
        if (activeTab && activePaginationInfo) {
          const match = activePaginationInfo.textContent.match(/\((\d+) –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π\)/);
          const activeCount = match ? match[1] : document.querySelectorAll('#active-events .event-card').length;
          activeTab.textContent = `–ê–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (${activeCount})`;
        }
        
        if (archivedTab && archivedPaginationInfo) {
          const match = archivedPaginationInfo.textContent.match(/\((\d+) –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π\)/);
          const archivedCount = match ? match[1] : document.querySelectorAll('#archived-events .event-card').length;
          archivedTab.textContent = `–ê—Ä—Ö–∏–≤ (${archivedCount})`;
        }
      }

      // Function to change items per page
      function changePerPage(perPage, tab) {
        const url = new URL(window.location.href);
        url.searchParams.set('per_page', perPage);
        url.searchParams.set('page', '1'); // Reset to first page
        
        if (tab === 'archived') {
          url.searchParams.set('tab', 'archived');
        } else {
          url.searchParams.delete('tab');
        }
        
        window.location.href = url.toString();
      }

      function openGroupMessageModal() {
        document.getElementById('groupMessageText').value = '';
        document.getElementById('groupMessageModal').style.display = 'block';
        document.getElementById('groupMessageText').focus();
      }

      function closeGroupMessageModal() {
        document.getElementById('groupMessageModal').style.display = 'none';
      }

      function sendGroupMessage() {
        const message = document.getElementById('groupMessageText').value.trim();
        if (!message) {
          alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
          return;
        }

        // Send message via fetch
        const formData = new FormData();
        formData.append('message', message);
        
        fetch('/group/{{ group[0] }}/send-group-message{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≥—Ä—É–ø–ø—É');
            closeGroupMessageModal();
          } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        });
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
        const groupModal = document.getElementById('groupMessageModal');
        if (event.target === groupModal) {
          closeGroupMessageModal();
        }
      }
    </script>
  </body>
  </html>


