<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>{{ group[2] if group else ('Группа ' ~ group[0]) }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      .event-card { position: relative; padding: 12px 44px 12px 12px; border-radius: 12px; background: var(--card); margin-bottom: 12px; }
      .event-card .actions { width: 100%; }
      .event-head { display:flex; align-items: baseline; justify-content: space-between; gap: 12px; }
      .event-title { font-weight: 700; font-size: 16px; }
      .event-date { color: var(--muted); font-size: 14px; }
      .gear { position:absolute; top: 10px; right: 10px; text-decoration:none; }
      .gear-inline { position: static; text-decoration: none; }
      .row { display: flex; gap: 8px; align-items: center; width: 100%; }
      .row .name-input { flex: 1 1 auto; min-width: 0; width: 100%; }
      .row .time-input { flex: 1 1 auto; min-width: 180px; max-width: 220px; width: 100%; }
      .actions { display:flex; gap:8px; margin-top: 8px; align-items: center; flex-wrap: wrap; }
      .responsible { color: var(--muted); font-size: 13px; margin-top: 6px; }
      .select { min-width: 180px; }
      .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 12px 20px; border-radius: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); background: #16a34a; color: #fff; display: none; }
      .meta-line { color: var(--muted); font-size: 14px; margin-top: 4px; }
      .group-header { display: flex; align-items: center; justify-content: space-between; }
      .group-gear { text-decoration: none; }
      .row-actions { display:flex; align-items:center; gap:8px; margin-top:6px; }
      .btn-small { padding: 8px 10px; border-radius: 8px; background: var(--danger); color:#fff; border:0; cursor:pointer; }
      .autocomplete-container { flex: 1 1 auto; min-width: 180px; position: relative; }
      .autocomplete-input { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px; }
      .autocomplete-dropdown { position: absolute !important; top: 100% !important; left: 0 !important; right: 0 !important; background: #1f2937 !important; border: 1px solid #374151 !important; border-radius: 8px !important; max-height: 200px !important; overflow-y: auto !important; z-index: 1000 !important; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important; margin-top: 4px !important; opacity: 1 !important; }
      .autocomplete-option { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #374151; background: #1f2937 !important; color: #f9fafb !important; }
      .autocomplete-option:hover { background: #374151 !important; }
      .autocomplete-option:last-child { border-bottom: none; }
      
      .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
      .modal-content { background-color: #1f2937 !important; margin: 5% auto; padding: 0; border-radius: 8px; width: 90%; max-width: 450px; max-height: 90vh; box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important; opacity: 1 !important; display: flex; flex-direction: column; }
      .modal-header { padding: 16px 20px; border-bottom: 1px solid #374151 !important; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
      .modal-header h3 { margin: 0; color: #f9fafb !important; }
      .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #f9fafb !important; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
      .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
      .modal-footer { padding: 16px 20px; border-top: 1px solid #374151 !important; display: flex; gap: 8px; justify-content: flex-end; flex-shrink: 0; }
      .message-btn:hover { background: #2563eb !important; }
      #groupMessageText { width: 300px !important; }
      .search-container {
        position: relative;
        display: flex;
        align-items: flex-start;
        padding: 12px 44px 12px 12px;
        border-radius: 12px;
        background: var(--card);
        margin-bottom: 12px;
      }
      .search-box {
        width: 100%;
        padding: 0;
        border: none;
        border-radius: 0;
        background: transparent;
        color: var(--text);
        font-size: 16px;
        outline: none;
      }
      .search-clear {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 16px;
        padding: 4px;
        display: none;
      }
      .search-clear:hover {
        color: var(--text);
      }
      .search-clear.show {
        display: block;
      }
      
      /* Стили для вкладок */
      .tabs-container {
        margin-bottom: 20px;
      }
      
      .tabs-header {
        display: flex;
        border-bottom: 2px solid var(--border);
        margin-bottom: 16px;
      }
      
      .tab-btn {
        background: none;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: var(--muted);
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
      }
      
      .tab-btn:hover {
        color: var(--text);
      }
      
      .tab-btn.active {
        color: var(--text);
        border-bottom-color: var(--primary);
      }
      
      .tab-content {
        display: block;
      }
      
      /* Стили для архивных мероприятий */
      .archived-event {
        opacity: 0.7;
        background: #374151 !important;
      }
      
      .archived-event .event-title a {
        color: #9ca3af !important;
      }
      
      .archived-event .event-date {
        color: #6b7280 !important;
      }
      
      .archived-event .responsible {
        color: #6b7280 !important;
      }
      
      /* Стили для пагинации */
      .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        padding: 12px 0;
        border-top: 1px solid var(--border);
      }
      
      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .pagination-btn {
        padding: 6px 12px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      
      .pagination-btn:hover:not(.disabled) {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      
      .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .pagination-info {
        color: var(--muted);
        font-size: 14px;
      }
      
      .per-page-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }
      
      .per-page-selector select {
        padding: 4px 8px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: 4px;
        font-size: 14px;
      }
      
      /* Мобильные стили для полей в модальном окне */
      @media (max-width: 768px) {
        .modal-content {
          width: 95% !important;
          max-width: none !important;
        }
        
        .modal-body .item input[name="name"] {
          flex: 3 !important;
        }
        
        .modal-body .item input[name="time"] {
          flex: 0.8 !important;
          min-width: 120px !important;
          max-width: 140px !important;
        }
        
        .modal-body .item .autocomplete-container {
          max-width: 80px !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="toast" class="toast"></div>
      <a class="link" href="/{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">← Назад</a>
      <div class="group-header">
        <h2>{{ group[2] if group else '' }}</h2>
        <div style="display: flex; gap: 8px; align-items: center;">
          {% if is_admin %}
          <button class="message-btn" onclick="openGroupMessageModal()" style="background: #3b82f6; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">✉️</button>
          {% endif %}
          <a class="group-gear" href="/group/{{ group[0] }}/settings{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" aria-label="Настройки">⚙️</a>
        </div>
      </div>
      <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1;">
          <div class="meta-line">#{{ group[0] }}</div>
          <div class="meta-line">{{ group[1] }}</div>
          <div class="meta-line">Роль: {{ role }}</div>
          <div class="meta-line">Мероприятий: {{ event_count }}</div>
        </div>
        {% if is_admin %}
          <div style="display: flex; align-items: center; height: 56px; margin-top: 28px;">
            <button class="btn" onclick="openCreateEventModal()" style="background: #16a34a; color: white; padding: 8px 16px; font-size: 14px; border-radius: 6px; white-space: nowrap;">
              ➕ Создать мероприятие
            </button>
          </div>
        {% endif %}
      </div>

      <!-- Вкладки для мероприятий -->
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-btn {% if active_tab == 'active' %}active{% endif %}" id="active-tab" onclick="switchEventTab('active')">
            Активные мероприятия ({{ active_pagination.total_items }})
          </button>
          <button class="tab-btn {% if active_tab == 'archived' %}active{% endif %}" id="archived-tab" onclick="switchEventTab('archived')">
            Архив ({{ archived_pagination.total_items }})
          </button>
        </div>
        
        <!-- Активные мероприятия -->
        <div class="tab-content" id="active-events" {% if active_tab != 'active' %}style="display: none;"{% endif %}>
          {% if not active_events %}
            <div class="empty">Нет активных мероприятий</div>
          {% else %}
            <div>
              <!-- Пагинация для активных мероприятий -->
              {% if active_pagination.total_pages > 1 %}
                <div class="pagination-container">
                  <div class="pagination-controls">
                    {% if active_pagination.has_prev %}
                      <a href="/group/{{ group[0] }}?page={{ active_pagination.current_page - 1 }}&per_page={{ per_page }}{% if request.query_params.get('tg_id') | safe_tg_id %}&tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" class="pagination-btn">← Назад</a>
                    {% else %}
                      <span class="pagination-btn disabled">← Назад</span>
                    {% endif %}
                    
                    <span class="pagination-info">
                      Страница {{ active_pagination.current_page }} из {{ active_pagination.total_pages }}
                      ({{ active_pagination.total_items }} мероприятий)
                    </span>
                    
                    {% if active_pagination.has_next %}
                      <a href="/group/{{ group[0] }}?page={{ active_pagination.current_page + 1 }}&per_page={{ per_page }}{% if request.query_params.get('tg_id') | safe_tg_id %}&tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" class="pagination-btn">Вперед →</a>
                    {% else %}
                      <span class="pagination-btn disabled">Вперед →</span>
                    {% endif %}
                  </div>
                  
                  <div class="per-page-selector">
                    <label for="activePerPage">Отображать:</label>
                    <select id="activePerPage" onchange="changePerPage(this.value, 'active')">
                      <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                      <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                      <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                      <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    </select>
                  </div>
                </div>
              {% endif %}
              
              <div class="search-container">
                <input type="text" id="eventSearch" class="search-box" placeholder="🔍 Поиск мероприятий..." />
                <button type="button" id="eventSearchClear" class="search-clear">✕</button>
              </div>
              <div id="eventsList">
                {% for e in active_events %}
              <div class="event-card" data-name="{{ e.name.lower() }}" data-date="{{ e.time_display.lower() }}" data-responsible="{{ e.responsible_name.lower() if e.responsible_name else '' }}">
              {% if is_admin %}
                <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/update-from-card{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
                  <!-- Первая строка: название и удаление -->
                  <div class="row" style="margin-bottom: 8px; width: 100%; justify-content: space-between;">
                    <input class="name-input" type="text" name="name" placeholder="Название" value="{{ e.name }}" style="flex: 1; margin-right: 8px;" />
                    <button class="btn" type="button" onclick="deleteEvent({{ e.id }})" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-size: 16px;">✕</button>
                  </div>
                  
                  <!-- Вторая строка: дата и время -->
                  <div class="row" style="margin-bottom: 12px; width: 100%;">
                    <input class="time-input" type="datetime-local" name="time" value="{{ e.time_input }}" style="flex: 1; margin-right: 8px; max-width: 180px;" />
                  </div>

                  {% if e.role_requirements and e.role_requirements|length > 0 %}
                  <div class="row" style="flex-direction: column; align-items: stretch; gap: 6px;">
                    {% for rname, req in e.role_requirements %}
                      <div class="row" style="gap: 8px; align-items: center;">
                        <div style="min-width: 120px; color: var(--muted);">{{ rname }}</div>
                        {% set assigned_uid = e.role_assignments.get(rname) %}
                        {% if assigned_uid %}
                          <div class="autocomplete-container" style="flex: 1;">
                            <input class="autocomplete-input" type="text" value="{{ e.role_assignment_labels.get(rname, member_name_map.get(assigned_uid, 'ID: ' ~ assigned_uid)) }}" disabled>
                          </div>
                          {% if is_admin or assigned_uid == current_user_id %}
                            <button class="btn" type="button" onclick="unbookRole({{ e.id }}, '{{ rname }}')" style="background: var(--danger);">Отменить бронь</button>
                          {% endif %}
                        {% else %}
                          {% if member_options and member_options|length > 0 %}
                            <div class="autocomplete-container" style="flex: 1; max-width: 220px;">
                              <input class="autocomplete-input" type="text" placeholder="— выбрать —" value="" data-user-id="" autocomplete="off">
                              <input type="hidden" name="selected_user_id" value="">
                              <div class="autocomplete-dropdown" style="display: none;">
                                <div class="autocomplete-option" data-value="">— выбрать —</div>
                                {% for uid, label in member_options %}
                                  <div class="autocomplete-option" data-value="{{ uid }}">{{ label }}</div>
                                {% endfor %}
                              </div>
                            </div>
                            <button class="btn" type="button" onclick="bookRoleFromRow(this, {{ e.id }}, '{{ rname }}')" {% if not e.allow_multi_roles_per_user and e.current_user_has_role %}disabled title="У вас уже есть роль в этом мероприятии"{% endif %}>Забронировать</button>
                          {% endif %}
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                  {% endif %}
                  
                  <!-- Кнопки: слева - сохранить, справа - настройки -->
                  <div class="actions" style="justify-content: space-between; margin-top: 8px;">
                    <div style="display: flex; gap: 8px;">
                      <button class="btn" type="submit">Сохранить</button>
                    </div>
                    <a class="gear-inline" href="/group/{{ group[0] }}/events/{{ e.id }}/settings{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" aria-label="Настройки оповещений" style="text-decoration: none; padding: 8px 12px; background: var(--primary); color: white; border-radius: 6px; font-size: 16px; border: none; cursor: pointer; display: inline-block; text-align: center; min-width: 40px;">🔔</a>
                  </div>
                  <!-- Скрытые поля для параметров пагинации -->
                  <input type="hidden" name="tab" value="{{ active_tab }}">
                  <input type="hidden" name="page" value="{{ current_page }}">
                  <input type="hidden" name="per_page" value="{{ per_page }}">
                </form>
              {% else %}
                <!-- Для обычных пользователей: карточка как у админов, но поля только для чтения -->
                <!-- Первая строка: название (read-only) -->
                <div class="row" style="margin-bottom: 8px; width: 100%; justify-content: space-between;">
                  <input class="name-input" type="text" name="name_ro" placeholder="Название" value="{{ e.name }}" style="flex: 1; margin-right: 8px;" disabled />
                </div>
                <!-- Вторая строка: дата и время (read-only) -->
                <div class="row" style="margin-bottom: 12px; width: 100%;">
                  <input class="time-input" type="datetime-local" name="time_ro" value="{{ e.time_input }}" style="flex: 1; margin-right: 8px; max-width: 180px;" disabled />
                </div>
                <!-- Роли: можно забронировать свободные и отменить свою бронь -->
                {% if e.role_requirements and e.role_requirements|length > 0 %}
                <div class="row" style="flex-direction: column; align-items: stretch; gap: 6px;">
                  {% for rname, req in e.role_requirements %}
                    <div class="row" style="gap: 8px; align-items: center;">
                      <div style="min-width: 120px; color: var(--muted);">{{ rname }}</div>
                      {% set assigned_uid = e.role_assignments.get(rname) %}
                      {% if assigned_uid %}
                        <div class="autocomplete-container" style="flex: 1;">
                          <input class="autocomplete-input" type="text" value="{{ e.role_assignment_labels.get(rname, member_name_map.get(assigned_uid, 'ID: ' ~ assigned_uid)) }}" disabled>
                        </div>
                        {% if assigned_uid == current_user_id %}
                          <button class="btn" type="button" onclick="unbookRole({{ e.id }}, '{{ rname }}')" style="background: var(--danger);">Отменить бронь</button>
                        {% endif %}
                      {% else %}
                        <div style="flex: 1; color: var(--muted);">Свободно</div>
                        <button class="btn" type="button" onclick="bookRoleFromRow(this, {{ e.id }}, '{{ rname }}')" {% if not e.allow_multi_roles_per_user and e.current_user_has_role %}disabled title="У вас уже есть роль в этом мероприятии"{% endif %}>Забронировать</button>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
                {% endif %}
                <div class="actions" style="justify-content: flex-end; margin-top: 8px;">
                  <a class="gear-inline" href="/group/{{ group[0] }}/events/{{ e.id }}/settings{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" aria-label="Настройки оповещений" style="text-decoration: none; padding: 8px 12px; background: var(--primary); color: white; border-radius: 6px; font-size: 16px; border: none; cursor: pointer; display: inline-block; text-align: center; min-width: 40px;">🔔</a>
                </div>
              {% endif %}
            </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
        
        <!-- Архивные мероприятия -->
        <div class="tab-content" id="archived-events" {% if active_tab != 'archived' %}style="display: none;"{% endif %}>
          {% if not archived_events %}
            <div class="empty">Нет архивных мероприятий</div>
          {% else %}
            <div>
              <!-- Пагинация для архивных мероприятий -->
              {% if archived_pagination.total_pages > 1 %}
                <div class="pagination-container">
                  <div class="pagination-controls">
                    {% if archived_pagination.has_prev %}
                      <a href="/group/{{ group[0] }}?page={{ archived_pagination.current_page - 1 }}&per_page={{ per_page }}&tab=archived{% if request.query_params.get('tg_id') | safe_tg_id %}&tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" class="pagination-btn">← Назад</a>
                    {% else %}
                      <span class="pagination-btn disabled">← Назад</span>
                    {% endif %}
                    
                    <span class="pagination-info">
                      Страница {{ archived_pagination.current_page }} из {{ archived_pagination.total_pages }}
                      ({{ archived_pagination.total_items }} мероприятий)
                    </span>
                    
                    {% if archived_pagination.has_next %}
                      <a href="/group/{{ group[0] }}?page={{ archived_pagination.current_page + 1 }}&per_page={{ per_page }}&tab=archived{% if request.query_params.get('tg_id') | safe_tg_id %}&tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" class="pagination-btn">Вперед →</a>
                    {% else %}
                      <span class="pagination-btn disabled">Вперед →</span>
                    {% endif %}
                  </div>
                  
                  <div class="per-page-selector">
                    <label for="archivedPerPage">Отображать:</label>
                    <select id="archivedPerPage" onchange="changePerPage(this.value, 'archived')">
                      <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                      <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                      <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                      <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    </select>
                  </div>
                </div>
              {% endif %}
              
              <div class="search-container">
                <input type="text" id="archivedEventSearch" class="search-box" placeholder="🔍 Поиск в архиве..." />
                <button type="button" id="archivedEventSearchClear" class="search-clear">✕</button>
              </div>
              <div id="archivedEventsList">
                {% for e in archived_events %}
              <div class="event-card archived-event" data-name="{{ e.name.lower() }}" data-date="{{ e.time_display.lower() }}" data-responsible="{{ e.responsible_name.lower() if e.responsible_name else '' }}">
              {% if is_admin %}
                <form method="post" action="/group/{{ group[0] }}/events/{{ e.id }}/update-from-card{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
                  <!-- Первая строка: название и удаление -->
                  <div class="row" style="margin-bottom: 8px; width: 100%; justify-content: space-between;">
                    <input class="name-input" type="text" name="name" placeholder="Название" value="{{ e.name }}" style="flex: 1; margin-right: 8px;" />
                    <button class="btn" type="button" onclick="deleteEvent({{ e.id }})" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-size: 16px;">✕</button>
                  </div>
                  
                  <!-- Вторая строка: дата и время -->
                  <div class="row" style="margin-bottom: 12px; width: 100%;">
                    <input class="time-input" type="datetime-local" name="time" value="{{ e.time_input }}" style="flex: 1; margin-right: 8px; max-width: 180px;" />
                  </div>

                  {% if e.role_requirements and e.role_requirements|length > 0 %}
                  <div class="row" style="flex-direction: column; align-items: stretch; gap: 6px;">
                    {% for rname, req in e.role_requirements %}
                      <div class="row" style="gap: 8px; align-items: center;">
                        <div style="min-width: 120px; color: var(--muted);">{{ rname }}</div>
                        {% set assigned_uid = e.role_assignments.get(rname) %}
                        <div class="autocomplete-container" style="flex: 1;">
                          {% if assigned_uid %}
                            <input class="autocomplete-input" type="text" value="{{ e.role_assignment_labels.get(rname, member_name_map.get(assigned_uid, 'ID: ' ~ assigned_uid)) }}" disabled>
                          {% else %}
                            <input class="autocomplete-input" type="text" value="Свободно" disabled>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                  {% endif %}
                  
                  <!-- Кнопки: слева - сохранить, справа - настройки -->
                  <div class="actions" style="justify-content: space-between; margin-top: 8px;">
                    <div style="display: flex; gap: 8px;">
                      <button class="btn" type="submit">Сохранить</button>
                    </div>
                    <a class="gear-inline" href="/group/{{ group[0] }}/events/{{ e.id }}/settings{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" aria-label="Настройки оповещений" style="text-decoration: none; padding: 8px 12px; background: var(--primary); color: white; border-radius: 6px; font-size: 16px; border: none; cursor: pointer; display: inline-block; text-align: center; min-width: 40px;">🔔</a>
                  </div>
                  <!-- Скрытые поля для параметров пагинации -->
                  <input type="hidden" name="tab" value="{{ active_tab }}">
                  <input type="hidden" name="page" value="{{ current_page }}">
                  <input type="hidden" name="per_page" value="{{ per_page }}">
                </form>
              {% else %}
                <!-- Название и дата (read-only) для участников -->
                <div class="row" style="margin-bottom: 8px; width: 100%; justify-content: space-between;">
                  <input class="name-input" type="text" placeholder="Название" value="{{ e.name }}" style="flex: 1; margin-right: 8px;" disabled />
                </div>
                <div class="row" style="margin-bottom: 12px; width: 100%;">
                  <input class="time-input" type="datetime-local" value="{{ e.time_input }}" style="flex: 1; margin-right: 8px; max-width: 180px;" disabled />
                </div>
                {% if e.role_requirements and e.role_requirements|length > 0 %}
                <div class="row" style="flex-direction: column; align-items: stretch; gap: 6px;">
                  {% for rname, req in e.role_requirements %}
                    <div class="row" style="gap: 8px; align-items: center;">
                      <div style="min-width: 120px; color: var(--muted);">{{ rname }}</div>
                      {% set assigned_uid = e.role_assignments.get(rname) %}
                      <div class="autocomplete-container" style="flex: 1;">
                        <input class="autocomplete-input" type="text" value="{% if assigned_uid %}{{ e.role_assignment_labels.get(rname, member_name_map.get(assigned_uid, 'ID: ' ~ assigned_uid)) }}{% else %}—{% endif %}" disabled>
                      </div>
                    </div>
                  {% endfor %}
                </div>
                {% endif %}
                <div class="actions" style="justify-content: flex-end; margin-top: 8px;">
                  <a class="gear-inline" href="/group/{{ group[0] }}/events/{{ e.id }}/settings{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}" aria-label="Настройки оповещений" style="text-decoration: none; padding: 8px 12px; background: var(--primary); color: white; border-radius: 6px; font-size: 16px; border: none; cursor: pointer; display: inline-block; text-align: center; min-width: 40px;">🔔</a>
                </div>
              {% endif %}
              </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Old form hidden - now using modal -->
      {% if is_admin %}
        <div style="display: none;">
          <h3>Добавить новое мероприятие</h3>
          <form id="bulkForm" method="post" action="/group/{{ group[0] }}/events/create-multiple{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
            <div id="rows"></div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button class="btn" type="button" id="addRow">＋ Добавить строку</button>
              <button class="btn" type="submit">Создать</button>
            </div>
          </form>
        </div>
        <script>
          (function(){
            const rows = document.getElementById('rows');
            const addRowBtn = document.getElementById('addRow');
            
            function initAutocomplete(container) {
              const input = container.querySelector('.autocomplete-input');
              const hidden = container.querySelector('input[name="responsible_user_id"]');
              const dropdown = container.querySelector('.autocomplete-dropdown');
              if (!input || !dropdown) return; // read-only rows or no dropdown
              const options = dropdown.querySelectorAll('.autocomplete-option');
              
              function filterOptions() {
                const query = input.value.toLowerCase();
                options.forEach(option => {
                  const text = option.textContent.toLowerCase();
                  option.style.display = text.includes(query) ? 'block' : 'none';
                });
                dropdown.style.display = 'block';
              }
              
              function selectOption(option) {
                input.value = option.textContent;
                hidden.value = option.dataset.value;
                dropdown.style.display = 'none';
              }
              
              input.addEventListener('input', filterOptions);
              input.addEventListener('focus', () => dropdown.style.display = 'block');
              
              options.forEach(option => {
                option.addEventListener('click', () => selectOption(option));
              });
              
              document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                  dropdown.style.display = 'none';
                }
              });
            }
            
            function makeRow() {
              const wrap = document.createElement('div');
              wrap.className = 'item';
              wrap.innerHTML = `
                <div class=\"row\">
                  <input class=\"name-input\" type=\"text\" name=\"name\" placeholder=\"Название\" />
                  <input class=\"time-input\" type=\"datetime-local\" name=\"time\" />
                  <button type=\"button\" class=\"del-row\" style=\"background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-left: 8px;\">✕</button>
                </div>
              `;
              return wrap;
            }
            
            function addRow() { 
              const row = makeRow();
              rows.appendChild(row);
              updateDeleteButtons();
              // Initialize autocomplete for existing dropdowns
              document.querySelectorAll('.autocomplete-container').forEach(initAutocomplete);
            }
            
            function updateDeleteButtons() {
              const items = rows.querySelectorAll('.item');
              items.forEach((item, index) => {
                const delBtn = item.querySelector('.del-row');
                if (delBtn) {
                  // Hide delete button for first row, show for others
                  delBtn.style.display = index === 0 ? 'none' : 'inline-block';
                }
              });
            }
            
            addRowBtn.addEventListener('click', addRow);
            rows.addEventListener('click', function(e){
              const btn = e.target.closest('.del-row');
              if (!btn) return;
              const item = btn.closest('.item');
              if (item) {
                item.remove();
                updateDeleteButtons();
              }
            });
            
            // Initialize autocomplete for existing dropdowns
            document.querySelectorAll('.autocomplete-container').forEach(initAutocomplete);
            // Init autocomplete for role booking selectors
            (function(){
              function initRoleAutocomplete(container) {
                const input = container.querySelector('.autocomplete-input');
                const form = container.closest('form');
                if (!form) return;
                const hidden = form.querySelector('input[name="selected_user_id"]');
                const dropdown = container.querySelector('.autocomplete-dropdown');
                if (!input || !hidden || !dropdown) return;
                const options = dropdown.querySelectorAll('.autocomplete-option');

                function filterOptions() {
                  const query = input.value.toLowerCase();
                  options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    option.style.display = text.includes(query) ? 'block' : 'none';
                  });
                  dropdown.style.display = 'block';
                }

                function selectOption(option) {
                  input.value = option.textContent;
                  input.dataset.userId = option.dataset.value;
                  hidden.value = option.dataset.value;
                  dropdown.style.display = 'none';
                }

                input.addEventListener('input', filterOptions);
                input.addEventListener('focus', () => dropdown.style.display = 'block');
                options.forEach(option => option.addEventListener('click', () => selectOption(option)));
                document.addEventListener('click', (e) => { if (!container.contains(e.target)) dropdown.style.display = 'none'; });
              }

              // Support both: containers inside forms and without
              document.querySelectorAll('.row .autocomplete-container').forEach(initRoleAutocomplete);
            })();
            
            // Note: Removed automatic tab movement on date change
            // Events will only move between tabs after form submission
            
            // start with one row
            addRow();
            updateDeleteButtons();
          })();
          
          // Event search functionality
          (function() {
            const searchInput = document.getElementById('eventSearch');
            const searchClear = document.getElementById('eventSearchClear');
            const eventsList = document.getElementById('eventsList');
            
            if (searchInput && eventsList) {
              function updateEventSearch() {
                const query = searchInput.value.toLowerCase().trim();
                const events = eventsList.querySelectorAll('.event-card');
                
                events.forEach(event => {
                  const name = event.getAttribute('data-name') || '';
                  const date = event.getAttribute('data-date') || '';
                  const responsible = event.getAttribute('data-responsible') || '';
                  
                  const matches = name.includes(query) || 
                                date.includes(query) || 
                                responsible.includes(query);
                  
                  event.style.display = matches ? 'block' : 'none';
                });
                
                // Show/hide clear button
                if (searchClear) {
                  searchClear.classList.toggle('show', query.length > 0);
                }
                
                // Hide pagination when searching
                const pagination = eventsList.parentElement.querySelector('.pagination-container');
                if (pagination) {
                  pagination.style.display = query.length > 0 ? 'none' : 'flex';
                }
              }
              
              searchInput.addEventListener('input', updateEventSearch);
              
              if (searchClear) {
                searchClear.addEventListener('click', function() {
                  searchInput.value = '';
                  updateEventSearch();
                  searchInput.focus();
                });
              }
            }
          })();
          
          // Archived events search functionality
          (function() {
            const searchInput = document.getElementById('archivedEventSearch');
            const searchClear = document.getElementById('archivedEventSearchClear');
            const eventsList = document.getElementById('archivedEventsList');
            
            if (searchInput && eventsList) {
              function updateArchivedEventSearch() {
                const query = searchInput.value.toLowerCase().trim();
                const events = eventsList.querySelectorAll('.event-card');
                
                events.forEach(event => {
                  const name = event.getAttribute('data-name') || '';
                  const date = event.getAttribute('data-date') || '';
                  const responsible = event.getAttribute('data-responsible') || '';
                  
                  const matches = name.includes(query) || 
                                date.includes(query) || 
                                responsible.includes(query);
                  
                  event.style.display = matches ? 'block' : 'none';
                });
                
                // Show/hide clear button
                if (searchClear) {
                  searchClear.classList.toggle('show', query.length > 0);
                }
                
                // Hide pagination when searching
                const pagination = eventsList.parentElement.querySelector('.pagination-container');
                if (pagination) {
                  pagination.style.display = query.length > 0 ? 'none' : 'flex';
                }
              }
              
              searchInput.addEventListener('input', updateArchivedEventSearch);
              
              if (searchClear) {
                searchClear.addEventListener('click', function() {
                  searchInput.value = '';
                  updateArchivedEventSearch();
                  searchInput.focus();
                });
              }
            }
          })();
        </script>
      {% endif %}
    </div>

    <!-- Group Message Modal -->
    <div id="groupMessageModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Отправить сообщение в группу</h3>
          <button class="close-btn" onclick="closeGroupMessageModal()">&times;</button>
        </div>
        <div class="modal-body">
          <textarea id="groupMessageText" placeholder="Введите сообщение для группы..." rows="4" style="width: 100%; padding: 8px; border: 1px solid #374151 !important; border-radius: 4px; resize: vertical; font-family: inherit; background: #1f2937 !important; color: #f9fafb !important;"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="sendGroupMessage()" style="background: #3b82f6;">Отправить</button>
          <button class="btn" onclick="closeGroupMessageModal()" style="background: #6b7280;">Отмена</button>
        </div>
      </div>
    </div>

    <!-- Create Event Modal -->
    <div id="createEventModal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3>Создать мероприятия</h3>
          <button class="close-btn" onclick="closeCreateEventModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form id="createEventForm" method="post" action="/group/{{ group[0] }}/events/create-multiple{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}">
            <div id="createEventRows"></div>
            <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
              <button class="btn" type="button" id="addCreateRow" style="background: #3b82f6;">➕ Добавить строку</button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="submitCreateEventForm()" style="background: #16a34a;">Создать мероприятия</button>
          <button class="btn" onclick="closeCreateEventModal()" style="background: #6b7280;">Отмена</button>
        </div>
      </div>
    </div>

    <script>
      // Add tg_id, tab, and pagination parameters to all forms automatically
      function addTgIdToForms() {
        const urlParams = new URLSearchParams(window.location.search);
        const tgId = urlParams.get('tg_id');
        const currentTab = urlParams.get('tab') || 'active';
        const currentPage = urlParams.get('page') || '1';
        const perPage = urlParams.get('per_page') || '10';
        
        // Remove all existing pagination and tab inputs first
        document.querySelectorAll('input[name="tab"], input[name="page"], input[name="per_page"]').forEach(input => {
          input.remove();
        });
        
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
          // Add tg_id if not present
          if (tgId && tgId !== 'None' && !form.querySelector('input[name="tg_id"]')) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'tg_id';
            input.value = tgId;
            form.appendChild(input);
          }
          
          // Add pagination parameters
          const pageInput = document.createElement('input');
          pageInput.type = 'hidden';
          pageInput.name = 'page';
          pageInput.value = currentPage;
          form.appendChild(pageInput);
          
          const perPageInput = document.createElement('input');
          perPageInput.type = 'hidden';
          perPageInput.name = 'per_page';
          perPageInput.value = perPage;
          form.appendChild(perPageInput);
          
          // Add tab parameter only to forms in the currently visible tab
          const isInActiveTab = form.closest('#active-events');
          const isInArchivedTab = form.closest('#archived-events');
          
          if (currentTab === 'archived' && isInArchivedTab) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'tab';
            input.value = 'archived';
            form.appendChild(input);
          } else if (currentTab === 'active' && isInActiveTab) {
            // For active tab, we don't add tab parameter (it's the default)
            // But we ensure no tab parameter exists
          }
        });
      }
      
      (function(){
        addTgIdToForms();
        
        const url = new URL(window.location.href);
        const ok = url.searchParams.get('ok');
        if (ok) {
          const toast = document.getElementById('toast');
          const map = { created: 'Мероприятие создано', updated: 'Сохранено', event_updated: 'Настройки мероприятия изменены', booked: 'Бронь оформлена', unbooked: 'Бронь снята', name_saved: 'Имя сохранено', noop: 'Нет данных для создания', event_deleted: 'Мероприятие удалено', event_booked: 'Мероприятие забронировано', booking_error: 'Ошибка бронирования' };
          toast.textContent = map[ok] || 'Готово';
          
          // Set color based on message type
          if (ok.includes('deleted') || ok.includes('error') || ok.includes('not_found') || ok.includes('in_past')) {
            toast.style.background = '#ef4444'; // Red for errors and deletions
          } else {
            toast.style.background = '#16a34a'; // Green for success
          }
          
          toast.style.display = 'block';
          url.searchParams.delete('ok');
          window.history.replaceState({}, '', url.toString());
          
          // Auto-hide toast after 3 seconds
          setTimeout(() => {
            if (toast) {
              toast.style.display = 'none';
            }
          }, 3000);
        }
      })();

      // Function to switch between event tabs
      function switchEventTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show selected tab content
        if (tabName === 'active') {
          document.getElementById('active-events').style.display = 'block';
          document.getElementById('active-tab').classList.add('active');
        } else if (tabName === 'archived') {
          document.getElementById('archived-events').style.display = 'block';
          document.getElementById('archived-tab').classList.add('active');
        }
        
        // Update URL with tab parameter
        const url = new URL(window.location.href);
        if (tabName === 'active') {
          url.searchParams.delete('tab');
        } else {
          url.searchParams.set('tab', tabName);
        }
        window.history.replaceState({}, '', url.toString());
        
        // Re-add form parameters for the new tab
        addTgIdToForms();
      }

      // Note: Removed checkEventTabMovement function
      // Events will only move between tabs after form submission and page reload

      // Function to update tab counts
      function updateTabCounts() {
        // Get total counts from pagination info
        const activePaginationInfo = document.querySelector('#active-events .pagination-info');
        const archivedPaginationInfo = document.querySelector('#archived-events .pagination-info');
        
        const activeTab = document.getElementById('active-tab');
        const archivedTab = document.getElementById('archived-tab');
        
        if (activeTab && activePaginationInfo) {
          const match = activePaginationInfo.textContent.match(/\((\d+) мероприятий\)/);
          const activeCount = match ? match[1] : document.querySelectorAll('#active-events .event-card').length;
          activeTab.textContent = `Активные мероприятия (${activeCount})`;
        }
        
        if (archivedTab && archivedPaginationInfo) {
          const match = archivedPaginationInfo.textContent.match(/\((\d+) мероприятий\)/);
          const archivedCount = match ? match[1] : document.querySelectorAll('#archived-events .event-card').length;
          archivedTab.textContent = `Архив (${archivedCount})`;
        }
      }

      // Function to change items per page
      function changePerPage(perPage, tab) {
        const url = new URL(window.location.href);
        url.searchParams.set('per_page', perPage);
        url.searchParams.set('page', '1'); // Reset to first page
        
        if (tab === 'archived') {
          url.searchParams.set('tab', 'archived');
        } else {
          url.searchParams.delete('tab');
        }
        
        window.location.href = url.toString();
      }

      // Create Event Modal Functions
      function openCreateEventModal() {
        document.getElementById('createEventModal').style.display = 'block';
        // Initialize with one row
        addCreateEventRow();
      }

      function closeCreateEventModal() {
        document.getElementById('createEventModal').style.display = 'none';
        // Clear the form
        document.getElementById('createEventRows').innerHTML = '';
      }

      function addCreateEventRow() {
        const rows = document.getElementById('createEventRows');
        const rowIndex = rows.children.length;
        const isFirstRow = rowIndex === 0;
        
        const row = document.createElement('div');
        row.className = 'item';
        row.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 8px; padding: 8px; border: 1px solid var(--border); border-radius: 6px;';
        
        row.innerHTML = `
          <input type="text" name="name" placeholder="Название мероприятия" style="flex: 2; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text);">
          <input type="datetime-local" name="time" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text);">
          <button type="button" class="del-row" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer;">✕</button>
        `;
        
        rows.appendChild(row);
        
        // Add delete functionality
        const deleteBtn = row.querySelector('.del-row');
        deleteBtn.addEventListener('click', function() {
          row.remove();
          updateCreateEventDeleteButtons();
        });
        
        updateCreateEventDeleteButtons();
      }

      function updateCreateEventDeleteButtons() {
        const rows = document.getElementById('createEventRows');
        const items = rows.querySelectorAll('.item');
        
        // Make delete button invisible for first row, visible for others
        items.forEach((item, index) => {
          const deleteBtn = item.querySelector('.del-row');
          if (deleteBtn) {
            if (index === 0) {
              deleteBtn.style.visibility = 'hidden';
              deleteBtn.style.pointerEvents = 'none';
            } else {
              deleteBtn.style.visibility = 'visible';
              deleteBtn.style.pointerEvents = 'auto';
            }
          }
        });
      }

      function submitCreateEventForm() {
        const form = document.getElementById('createEventForm');
        const rows = document.getElementById('createEventRows');
        
        // Check if there are any rows with data
        let hasData = false;
        const nameInputs = rows.querySelectorAll('input[name="name"]');
        const timeInputs = rows.querySelectorAll('input[name="time"]');
        
        for (let i = 0; i < nameInputs.length; i++) {
          if (nameInputs[i].value.trim() || timeInputs[i].value.trim()) {
            hasData = true;
            break;
          }
        }
        
        if (!hasData) {
          alert('Добавьте хотя бы одно мероприятие');
          return;
        }
        
        // Submit the form
        form.submit();
      }

      function openGroupMessageModal() {
        document.getElementById('groupMessageText').value = '';
        document.getElementById('groupMessageModal').style.display = 'block';
        document.getElementById('groupMessageText').focus();
      }

      function closeGroupMessageModal() {
        document.getElementById('groupMessageModal').style.display = 'none';
      }

      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        
        // Set color based on message type
        if (type === 'error') {
          toast.style.background = '#ef4444'; // Red for errors
        } else {
          toast.style.background = '#16a34a'; // Green for success
        }
        
        toast.style.display = 'block';
        
        // Auto-hide toast after 3 seconds
        setTimeout(() => {
          if (toast) {
            toast.style.display = 'none';
          }
        }, 3000);
      }

      function bookEvent(eventId) {
        console.log('Booking event:', eventId);
        const formData = new FormData();
        formData.append('tab', '{{ active_tab }}');
        formData.append('page', '{{ current_page }}');
        formData.append('per_page', '{{ per_page }}');
        
        fetch('/group/{{ group[0] }}/events/' + eventId + '/book{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            showToast('Мероприятие забронировано', 'success');
            // Reload page to show updated state
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            showToast('Ошибка бронирования', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Ошибка бронирования', 'error');
        });
      }

      function unbookEvent(eventId) {
        console.log('Unbooking event:', eventId);
        const formData = new FormData();
        formData.append('tab', '{{ active_tab }}');
        formData.append('page', '{{ current_page }}');
        formData.append('per_page', '{{ per_page }}');
        
        fetch('/group/{{ group[0] }}/events/' + eventId + '/unbook{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            showToast('Бронь отменена', 'success');
            // Reload page to show updated state
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            showToast('Ошибка отмены брони', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Ошибка отмены брони', 'error');
        });
      }

      function bookRoleFromRow(btn, eventId, roleName) {
        const row = btn.closest('.row');
        const container = row ? row.querySelector('.autocomplete-container') : null;
        const hidden = container ? container.querySelector('input[name="selected_user_id"]') : null;
        const selected = hidden && hidden.value ? hidden.value : '';
        const formData = new FormData();
        formData.append('tab', '{{ active_tab }}');
        formData.append('page', '{{ current_page }}');
        formData.append('per_page', '{{ per_page }}');
        if (selected) formData.append('selected_user_id', selected);
        fetch(`/group/{{ group[0] }}/events/${eventId}/roles/${encodeURIComponent(roleName)}/book{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}`, {
          method: 'POST',
          body: formData
        }).then(r => {
          if (r.ok) {
            showToast('Бронь оформлена');
            setTimeout(() => location.reload(), 800);
          } else {
            showToast('Ошибка бронирования', 'error');
          }
        }).catch(() => showToast('Ошибка бронирования', 'error'));
      }

      function unbookRole(eventId, roleName) {
        const formData = new FormData();
        formData.append('tab', '{{ active_tab }}');
        formData.append('page', '{{ current_page }}');
        formData.append('per_page', '{{ per_page }}');
        fetch(`/group/{{ group[0] }}/events/${eventId}/roles/${encodeURIComponent(roleName)}/unbook{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}`, {
          method: 'POST',
          body: formData
        }).then(r => {
          if (r.ok) {
            showToast('Бронь отменена');
            setTimeout(() => location.reload(), 800);
          } else {
            showToast('Ошибка отмены брони', 'error');
          }
        }).catch(() => showToast('Ошибка отмены брони', 'error'));
      }

      function deleteEvent(eventId) {
        // Показываем подтверждение
        if (!confirm('Вы уверены, что хотите удалить это мероприятие?')) {
          return;
        }
        
        console.log('Deleting event:', eventId);
        const formData = new FormData();
        formData.append('tab', '{{ active_tab }}');
        formData.append('page', '{{ current_page }}');
        formData.append('per_page', '{{ per_page }}');
        
        fetch('/group/{{ group[0] }}/events/' + eventId + '/delete{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            showToast('Мероприятие удалено', 'error');
            // Reload page to show updated state
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            showToast('Ошибка удаления мероприятия', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Ошибка удаления мероприятия', 'error');
        });
      }

      function sendGroupMessage() {
        const message = document.getElementById('groupMessageText').value.trim();
        if (!message) {
          showToast('Введите сообщение', 'error');
          return;
        }

        // Send message via fetch
        const formData = new FormData();
        formData.append('message', message);
        
        fetch('/group/{{ group[0] }}/send-group-message{% if request.query_params.get('tg_id') | safe_tg_id %}?tg_id={{ request.query_params.get('tg_id') | safe_tg_id }}{% endif %}', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('Сообщение отправлено в группу', 'success');
            closeGroupMessageModal();
          } else {
            showToast('Ошибка отправки: ' + (data.error || 'Неизвестная ошибка'), 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Ошибка отправки сообщения', 'error');
        });
      }

      // Initialize create event modal button
      document.addEventListener('DOMContentLoaded', function() {
        const addCreateRowBtn = document.getElementById('addCreateRow');
        if (addCreateRowBtn) {
          addCreateRowBtn.addEventListener('click', addCreateEventRow);
        }
      });

      // Close modal when clicking outside
      window.onclick = function(event) {
        const groupModal = document.getElementById('groupMessageModal');
        const createModal = document.getElementById('createEventModal');
        
        if (event.target === groupModal) {
          closeGroupMessageModal();
        }
        if (event.target === createModal) {
          closeCreateEventModal();
        }
      }
    </script>
  </body>
  </html>


